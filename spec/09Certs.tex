\chapter{Облегченные сертификаты}\label{CERTS}

\section{Формат}\label{CERTS.Format}

Облегченные сертификаты (card verifiable certificates в~\cite{LightCerts}) 
имеют меньший объем и более простой формат, чем стандартные сертификаты,
определенные в СТБ 34.101.19.

Облегченный сертификат описывается следующими типами АСН.1.
В типах применяется неявное (\verb|IMPLICIT|) тегирование. 

\begin{verbatim}
CVCertificate ::= [APPLICATION 33] SEQUENCE {
  certificateBody                   [APPLICATION 78] SEQUENCE {
    certProfileIdentifier           [APPLICATION 41] INTEGER {v1(0)},
    certAuthorityReference          [APPLICATION 2]  CharString,
    publicKey                       [APPLICATION 73] PubKey,
    certHolderReference             [APPLICATION 32] CharString,
    certHolderAuthorizationTemplate [APPLICATION 76] CertHAT OPTIONAL,
    certEffectiveDate               [APPLICATION 37] CVDate,
    certExpirationDate              [APPLICATION 36] CVDate,
    certExtensions                  [APPLICATION 5]  CVExt OPTIONAL 
  },
  signature                         [APPLICATION 55] OCTET STRING
}

CharString ::= PrintableString (SIZE (8..14))

PubKey ::= SEQUENCE {
  objIdentifier         OBJECT IDENTIFIER,
  pubKeyandParameters   PublicKey
}

CVDate :: = NumericString (SIZE(6))
CVExt ::= SEQUENCE OF DiscretionaryDataTemplate
\end{verbatim}

Компоненты, вложенные в \verb|CVCertificate|, имеют следующее значение.
\begin{enumerate}
\item
Компонент \verb|certProfileIdentifier| определяет версию формата. 

\item
Компонент \verb|certAuthorityReference| идентифицирует эмитента 
(УЦ, выпустившего сертификат). 
Представляет собой строку \str{BYCA0XXX} для корневых УЦ либо  
строку \str{BYCA1XXX} для подчиненных. Здесь \str{XXX}~--- 
номер УЦ (см.~\ref{OBJ.Certs}).

\item
Компонент \verb|publicKey| описывает открытый ключ.
%
Вложенный компонент \verb|objIdentifier| 
должен принимать значение \texttt{bign-pubkey}, 
заданное в СТБ 34.101.45 (приложение Д).
%
Открытый ключ записывается во вложенный компонент~\verb|pubKeyandParameters| 
типа~\verb|PublicKey|. Этот тип определен в СТБ 34.101.45 следующим образом: 
\begin{verbatim} 
PublicKey ::= BIT STRING (SIZE(512|768|1024))
\end{verbatim} 

По длине открытого ключа определяется уровень стойкости и стандартные параметры  
эллиптической кривой этого уровня (см.~\ref{CRYPTO}).

\item
Компонент \verb|certHolderReference| идентифицирует субъекта (владельца) 
сертификата. Если субъектом является УЦ, то при формировании компонента 
повторяется логика \verb|certAuthorityReference|. Если же субъектом является КТ 
или терминал, то идентификационная строка должна быть получена добавлением к 
серийному номеру субъекта префикса~\str{BY}. Например, \str{BY590082394654}. 
Длина серийного номера должна быть в диапазоне от 8 до 12 символов.

\item
Компонент \verb|certHolderAuthorizationTemplate| определяет права доступа 
субъекта сертификата к прикладной программе eID. Правила формирования 
компонента определены в~\ref{DATA.Access}.

Компонент должен отсутствовать в сертификате КТ.
%
Отсутствие компонента в других сертификатах означает отсутствие прав 
доступа к eID. 

\item
Компонент \verb|certEffectiveDate| определяет дату выпуска сертификата.
%
Дата задается строкой формата \texttt{YYMMDD}, 
в которой \texttt{YY}~--- год текущего века, 
\texttt{MM}~--- месяц, \texttt{DD}~--- день.

\item
Компонент \verb|certExpirationDate| определяет время окончания действия 
сертификата.

\item
Компонент \verb|certExtensions| определяет список расширений, 
которые содержат дополнительную информацию о субъекте сертификата. 

Настоящий стандарт допускает только одно расширение, которое описывает 
права доступа к прикладной программе eSign. 
Расширению назначается идентификатор~\verb|id-SignAuthExt|,
определенный в приложении~\ref{ASN}. Этот идентификатор указывается
в компоненте~\texttt{objIdentifier} типа \texttt{DiscretionaryDataTemplate},
а в компоненте~\texttt{dataObjects} указывается значение типа \verb|CertHAT|.
Правила формирования значения определены в~\ref{DATA.Access}. 

Компонент \verb|certExtensions| должен отсутствовать в сертификате КТ.
%
Отсутствие компонента в других сертификатах означает отсутствие прав доступа к 
eSign. 

\item
Компонент \verb|signature| содержит ЭЦП сертификата, выработанную УЦ.
Уровень стойкости ключей УЦ не должен быть ниже уровня стойкости 
ключей субъекта сертификата.
\end{enumerate}

\section{Проверка маршрута сертификации}\label{CERTS.Path}

В протоколе аутентификации BAUTH терминал предъявляет КТ свой маршрут сертификации 
без первого (корневого) сертификата. 
%
Сертификаты маршрута должны предъявляться последовательно, начиная с сертификата,
выпущенного корневым УЦ, и заканчивая сертификатом терминала.
%
КТ определяет недостающий сертификат по идентификатору эмитента 
(\texttt{certAuthorityReference}) в первом сертификате представленной 
терминалом цепочки. 
%
Если самоподписанный сертификат с нужным идентификатором не был записан 
на КТ во время выпуска в обращение, то проверка маршрута заканчивается
ошибкой. Иначе найденный сертификат вставляется в первую позицию маршрута.

В ответ КТ может предъявить терминалу свой сертификат.
%
Терминал восстанавливает маршрут сертификации КТ, используя предустановленные 
сертификаты УЦ или онлайн-доступ к сервисам получения таких сертификатов.
%
Восстановление маршрута выполняется последовательно, начиная с сертификата КТ и
заканчивая корневым сертификатом. Для определения очередного сертификата
используется идентификатор эмитента, указанный в предыдущем. Проверка
сертификата КТ завершается ошибкой, если маршрут восстановить не удалось.

При проверке маршрута его сертификаты последовательно просматриваются, начиная 
с корневого. Проверка проводится следующим образом:
\begin{enumerate}
\item
Проверяется, что эмитент следующего сертификата является субъектом текущего.

\item
Проверяется, что текущая дата попадает в срок действия каждого сертификата маршрута. 
Если проверка проводится на КТ без аппаратного таймера, то оценка текущей даты 
(см.~\ref{OBJ.Date}) обновляется: она устанавливается равной самой поздней из дат 
выпуска сертификатов маршрута.

\item
Проверяется, что расширения сертификатов удовлетворяют правилам,
заданным в~\ref{CERTS.Format}.

\item
ЭЦП каждого следующего сертификата проверяется на открытом ключе текущего.
\end{enumerate}

Если проверка проводится КТ, то дополнительно определяются права доступа
терминала к прикладным программам токена. Слово прав доступа к eID (eSign) 
определяется в результате наложения слов, указанных в
компонентах~\texttt{certHolderAuthorizationTemplate} 
(расширениях~\texttt{id-SignAuthExt}) сертификатов.
%
Наложение выполняется с помощью операции $\wedge$ (логическое И). 
Отсутствующее слово интерпретируется как нулевое.

Если проверка проводится терминалом, то дополнительно могут контролироваться
статусы отзыва сертификатов маршрута. Проверка завершается ошибкой, если 
маршрут содержит отозванный сертификат. 
%
Проверку статуса отзыва нельзя выполнить на КТ, и поэтому сертификаты 
терминалов рекомендуется обновлять как можно чаще.


