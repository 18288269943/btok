\section{Описание операций}\label{Oper.Descr}

\subsection{Активация личного ключа}\label{Oper.Descr.ActivateKey}

Для активации личного ключа используется команда <Activate>.
\addendum{Команда определена в} таблице~\ref{Table.Oper.ActivateCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.ActivateCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\
\hline
\hline
INS & $\hex{44}$: активировать\\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{2100}$: 
активировать ключ, определяемый CDF\\
\hline
CDF &  $\der(\hex{84}, X)$,   
где $X$ определяет идентификатор личного ключа 
(см. таблицу~\ref{Table.Oper.KeyRef}) \\ 
\hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$: ключ активирован успешно. \\
%  & $ \hex{6A88}$: cсылочные данные (ключ) не найдены \\
  & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

При генерации личного ключа (см.~\ref{Oper.Descr.GenKeys})
он автоматически активируется, и в вызове команды <Activate> нет явной 
необходимости. \addendum{Вызов может} потребоваться после 
принудительной деактивации ключа (см.~\ref{Oper.Descr.DeactivateKey}).  

Если ключ уже активирован, то должен быть 
возвращен статус $\text{SW1} \parallel \text{SW2} = \hex{9000}$.

Команда может быть вызвана \addendum{при выборе файла} eSign в 
состояниях PS, AS:AT. В состоянии AS:AT команда может быть вызвана только 
авторизованным терминалом, в сертификате которого задано 
право активировать ключи (см.~\ref{DATA.Access}).

Команда требует предварительной аутентификации по PIN.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Активация PIN}\label{Oper.Descr.ActivatePIN}

Для активации PIN (см.~\ref{OBJ.PWD})  используется команда <Activate>.
\addendum{Команда определена в} таблице~\ref{Table.Oper.ActivatePINCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.ActivatePINCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\
\hline
\hline
INS & $\hex{44}$: активировать\\
\hline
P1 & $\hex{10}$: активировать пароль, определяемый P2\\
\hline
P2 & $\hex{03}$: PIN \\
\hline
CDF &  ---  \\
\hline 
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
  $\hex{9000}$:  PIN активирован успешно.\\
  & Другое: см. таблицу~\ref{Table.Errors.General}\\
\hline
\end{tabular}
\end{table}

Первоначально PIN \addendum{активирован}, и в вызове команды <Activate> 
нет явной необходимости. Вызов команды может потребоваться после 
принудительной деактивации PIN (см.~\ref{Oper.Descr.DeactivatePIN}). 

Если PIN уже активирован, то должен быть возвращен 
статус $\text{SW1} \parallel \text{SW2} = \hex{9000}$.

Команда может быть вызвана \addendum{при выборе файла} eSign 
в состояниях PS, AS:AT и \addendum{при выборе файла} eID в состоянии 
AS:AT. В состоянии AS:AT команда может быть вызвана 
только авторизованным терминалом, в сертификате которого задано 
право активации пароля PIN (см.~\ref{DATA.Access}).

Команда требует предварительной аутентификации по PUK.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Выбор мастер-файла}
\label{Oper.Descr.SelectMF}

Для выбора \addendum{мастер-файла используется} команда 
<Select File>. \addendum{Команда определена в} 
таблице~\ref{Table.Oper.SelectMFCmd}. 

\begin{table}[hbt]
\caption{}\label{Table.Oper.SelectMFCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{A4}$: выбрать файл\\ 
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{0000}$: выбор мастер-файла\\
\hline
CDF & --- \\
\hline 
RDF &  --- \\
\hline
$\text{SW1}\parallel\text{SW2}$ & 
$\hex{9000}$: мастер-файл выбран успешно. \\
  & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Если мастер-файл уже выбран, то должен быть возвращен 
статус $\text{SW1} \parallel \text{SW2} = \hex{9000}$.

Команда может быть вызвана в любом из \addendum{состояний.}

После успешного выполнения команды \addendum{мастер-файл становится выбранным}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Выбор прикладной программы}
\label{Oper.Descr.SelectApp}

Для выбора прикладной программы используется команда <Select File>. 
\addendum{Команда определена в} таблице~\ref{Table.Oper.SelectAppCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.SelectAppCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{A4}$: выбрать файл\\ 
\hline
P1 & $\hex{04}$: выбор прикладной программы\\
\hline
P2 & $\hex{0C}$: возврат информации о файле не требуется \\
\hline
CDF & AID прикладной программы (см. приложение~\ref{FILES})\\
\hline 
RDF &  --- \\
\hline
$\text{SW1}\parallel\text{SW2}$ & 
$\hex{9000}$: прикладная программа выбрана успешно; \\
  & $\hex{6A82}$: файл не найден. \\
  & Другое: см. таблицу~\ref{Table.Errors.General}\\
\hline
\end{tabular}
\end{table}

Команда может быть вызвана в состояниях \addendum{PS и AS}.

Для выбора \addendum{прикладной программы} eSign команда требует 
предварительной аутентификации по PIN или PUK.

Для выбора \addendum{прикладной программы} eID команда требует 
предварительной аутентификации по CAN, PIN или PUK.

Если прикладная программа уже выбрана, то должен быть возвращен
статус $\text{SW1} \parallel \text{SW2} = \hex{9000}$.

После успешного выполнения команды \addendum{файл прикладной программы 
становится выбранным}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Выбор элементарного файла}
\label{Oper.Descr.SelectEF}

Для выбора элементарного файла используется команда <Select File>. 
\addendum{Команда определена в} таблице~\ref{Table.Oper.SelectEFCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.SelectEFCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{A4}$: выбрать файл\\ 
\hline
P1 & $\hex{02}$: выбор элементарного файла для текущей прикладной программы\\
\hline
P2 & $\hex{0C}$: возврат информации о файле не требуется \\
\hline
CDF & FID файла для текущей прикладной программы (см. приложение~\ref{FILES})\\
\hline 
RDF &  --- \\
\hline
$\text{SW1}\parallel\text{SW2}$ & 
$\hex{9000}$: элементарный файл выбран успешно; \\
  & $\hex{6A82}$: файл не найден. \\
  & Другое: см. таблицу~\ref{Table.Errors.General}\\
\hline
\end{tabular}
\end{table}

Команда может вызываться в состояниях PS, AS:AT 
\addendum{при выборе файла} eSign и в состоянии AS:AT \addendum{при выборе 
файла} eID. В состоянии AS:AT команда может вызываться только 
авторизованным терминалом, в сертификате которого
задано право доступа к соответствующему элементарному файлу (см.~\ref{DATA.Access}).

Для выбора элементарных файлов \addendum{прикладной программы} eSign 
\addendum{требуется предварительная аутентификация} по PIN.

Для выбора элементарных файлов \addendum{прикладной программы} eID 
\addendum{требуется предварительная аутентификация} по CAN или PIN.

Для выбора элементарных файлов в состоянии AS:AT
\addendum{требуется взаимная аутентификация} КТ и терминала
по протоколу BAUTH (см.~\ref{Oper.Descr.SetBAUTH}).

После успешного выполнения команды \addendum{элементарный файл
становится выбранным}.

\addendum{
Элементарные файлы, которые могут быть выбраны, 
приводятся в приложении~\ref{FILES}.  
Выбор элементарного файла может потребоваться для
чтения (см.~\ref{Oper.Descr.Read}) или 
обновления (см.~\ref{Oper.Descr.Update}) данных.
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Выполнение основных шагов протокола BAUTH}
\label{Oper.Descr.GABAUTH} 

Для выполнения основных шагов протокола BAUTH используется команда <General 
Authenticate>. 
\addendum{Команда определена в} таблице~\ref{Table.Oper.GABAUTHCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.GABAUTHCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & 	Описание \\
\hline
\hline
INS & $\hex{86}$: общая аутентификация \\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{0000}$: протокол уже задан\\ 
\hline
CDF & Отсутствует или $\der(\hex{7C}, X)$, 
где~$X$~--- сообщение протокола, сформированное терминалом
(см. таблицу~\ref{Table.Oper.BAUTH})\\
\hline 
RDF & Отсутствует или $\der(\hex{7C}, Y)$, где~$Y$~--- 
сообщение протокола, сформированное КТ 
(см. таблицу~\ref{Table.Oper.BAUTH})\\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$: протокол (шаг) выполнен успешно. \\
& $\hex{6300}$: протокол (шаг) выполнен с ошибкой;\\
  & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

\doubt{Для выполнения основных шагов} протокола BAUTH
должна вызываться цепочка команд <General Authenticate> 
с входными и выходными данными из таблицы~\ref{Table.Oper.BAUTH}, 
которые определяются в соответствии с~\ref{CRYPTO.BAUTH}. 
При односторонней аутентификации компонент RDF в ответе на вторую команду
в цепочке не возвращается.

\begin{table}[hbt]
\caption{Данные цепочки команд, реализующих протокол BAUTH}
\label{Table.Oper.BAUTH}
\begin{tabular}{|c|c|c|}
\hline
№ вызова & Данные в команде & Данные в ответе\\
\hline
\hline
1 & --- & $\der(\hex{80}, \text{M1})$\\
\hline
2 & $\der(\hex{81}, \text{M2})$ & 
$\der(\hex{82}, \text{M3})$  \\
\hline
\end{tabular}
\end{table}

Команда может вызываться \addendum{при выборе мастер-файла} в состоянии PS  
непосредственно после проверки сертификата терминала
(см.~\ref{Oper.Descr.VerifyCert}).

После успешного выполнения протокола BAUTH между КТ и терминалом 
устанавливается защищенное соединение (см.~\ref{CMDS.SM}).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Выполнение шагов протокола BPACE}
\label{Oper.Descr.GABPACE} 

Для выполнения шагов протокола BPACE используется команда <General 
Authenticate>. 
\addendum{Команда определена в} таблице~\ref{Table.Oper.GABPACECmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.GABPACECmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & 	Описание \\
\hline
\hline
INS & $\hex{86}$: общая аутентификация \\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{0000}$: протокол уже задан\\ 
\hline
CDF & $\der(\hex{7C}, X)$, 
где~$X$~--- сообщение протокола, сформированное КП (см. 
таблицу~\ref{Table.Oper.BPACE})\\ 
\hline 
RDF & $\der(\hex{7C}, Y)$, где~$Y$~--- 
сообщение протокола, сформированное КТ (см. таблицу~\ref{Table.Oper.BPACE})\\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
  $\hex{9000}$: протокол (шаг) выполнен успешно; \\
  & $\hex{63CX}$: протокол (шаг) выполнен с ошибкой, 
значение \texttt{X} содержит количество оставшихся попыток аутентификации 
(при $\texttt{X} = 1$ пароль приостановлен, а при $\texttt{X} = 0$~--- 
заблокирован); \\
  & $\hex{6984}$: пароль деактивирован. \\
  & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

\doubt{Для выполнения шагов} протокола BPACE должна вызываться цепочка 
команд <General Authenticate> с входными и выходными данными 
из таблицы~\ref{Table.Oper.BPACE}, 
которые определяются в соответствии с~\ref{CRYPTO.BPACE}. 

\begin{table}[hbt]
\caption{Данные цепочки команд, реализующих протокол BPACE}
\label{Table.Oper.BPACE}
\begin{tabular}{|c|c|c|}
\hline
№ вызова & Данные в команде & Данные в ответе\\
\hline
\hline
 & <General Authenticate> &  \\
\hline
\hline
1 & $\der(\hex{80}, \text{M1})$ & 
$\der(\hex{81}, \text{M2})$\\
\hline
2 & $\der(\hex{82}, \text{M3})$ & 
$\der(\hex{83}, \text{M4})$\\
\hline
\end{tabular}
\end{table}

Команда может вызываться \addendum{при выборе мастер-файла} в любом состоянии
непосредственно после инициализации протокола BPACE 
(см.~\ref{Oper.Descr.SetBPACE}).

Успешное выполнение протокола BPACE с использованием пароля PIN 
устанавливает \doubt{статус подтверждения пароля} PIN.
\doubt{
Ошибка при выполнении BPACE с паролем PIN сбрасывает статус подтверждения PIN,  
если он был установлен ранее.
}

После успешного выполнения протокола BPACE между КТ и КП 
устанавливается защищенное соединение (см.~\ref{CMDS.SM}).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Выработка подписи}
\label{Oper.Descr.Signature}

Для выработки подписи используется 
команда <PSO: Compute Digital Signature>
(аббр. от <<Perform Security Operation: Compute Digital Signature>>).
\addendum{Команда определена в} таблице~\ref{Table.Oper.SignatureCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.SignatureCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\ 
\hline
\hline
INS & $\hex{2A}$: управление средой безопасности \\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{9E9A}$: выработать
электронную подпись \\ 
\hline
CDF & Хэш-значение, вычисленное от данных\\
\hline 
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
  $\hex{9000}$: подпись выработана успешно. \\
  & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

В компоненте CDF команды должно передаваться хэш-значение, которое вычислено
от подписываемых данных алгоритмом хэширования, указанным 
при инициализации алгоритма подписи. \addendum{Длина хэш-значения должна 
соответствовать} уровню стойкости личного ключа, выбранного при инициализации 
алгоритма подписи (см.~\ref{Oper.Descr.SetDST}).

При выработке подписи используется алгоритм \texttt{bign-sign}
(см.~\ref{CRYPTO.StdAlg}) со стандартными параметрами СТБ 34.101.45 
(приложение Б), которые определяются неявно по уровню стойкости личного ключа.

%Команда требует предварительной аутентификации по 
%протоколу BPACE c паролем PIN. 

Команда может вызываться \addendum{при выборе файла} eSign в состояниях 
PS и AS:AT непосредственно после инициализации алгоритма подписи
(см.~\ref{Oper.Descr.SetDST}).
%В состоянии AS:AT команда может вызываться только авторизованным 
%терминалом с правом выработки подписи (см. \ref{DATA.Access}).

Выполнение команды приводит к сбрасыванию \doubt{статуса подтверждения} пароля PIN
после успешного или неуспешного выполнения $N$ команд, где $N$~--- значение, 
задаваемое при инициализации протокола BPACE (см.~\ref{Oper.Descr.SetBPACE}).
Для установки статуса подтверждения пароля PIN 
необходимо либо подтвердить пароль PIN (см.~\ref{Oper.Descr.VerifyPIN}), 
либо повторно выполнить аутентификацию по PIN (см.~\ref{Oper.Seq.BPACE}).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Генерация ключевой пары}\label{Oper.Descr.GenKeys}

Для генерации ключевой пары (личного и открытого \addendum{ключей}) прикладной 
программы eSign используется команда <Generate Asymmetric Key Pair>. При 
выполнении команды сгенерированный личный ключ сохраняется в КТ,
а открытый ключ возвращается как данные ответа.
После генерации личный ключ может использоваться 
для выработки подписи (см.~\ref{Oper.Descr.Signature}) и
разбора токена ключа (см.~\ref{Oper.Descr.Decipher}).
\addendum{Команда определена в} таблице~\ref{Table.Oper.GenKeysCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.GenKeysCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\
\hline
\hline
INS & $\hex{47}$: сгенерировать ключевую пару \\
\hline
$\text{P1} \parallel\text{P2}$ & $\hex{8200}$:
вернуть открытый ключ \\
\hline
CDF & $\der(\hex{B6},\der(\hex{84}, X))$,
где $X$ определяет идентификатор генерируемого личного ключа
(см. таблицу~\ref{Table.Oper.KeyRef}) \\
\hline 
RDF & $\der(\hex{7F49}, Y)$, где $Y$ является открытым ключом длины $4l$ бит\\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$: ключевая пара сгенерирована успешно. \\
  & $\hex{6984}$: ключ уже существует. \\
%  & $\hex{6A88}$: cсылочные данные (ключ) не найдены. \\
  & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Допустимые значения идентификаторов личного ключа определяются
в соответствии с таблицей~\ref{Table.Oper.KeyRef} и зависят от
уровня стойкости личного ключа и состояния КТ:
младшая тетрада идентификатора характеризует уровень стойкости ключа,
а старшая~--- состояние, в котором ключ может использоваться.
КТ должен поддерживать генерацию ключей уровня стойкости 
$l=128$ и может поддерживать генерацию ключей 
уровней стойкости $l=192,256$.

\begin{table}[hbt]
\caption{Допустимые значения идентификаторов личного ключа}
\label{Table.Oper.KeyRef}
\begin{tabular}{|c|c|c|c|}
\hline
Уровень стойкости & \multicolumn{2}{|c|}{Значение } & Поддержка\\
\cline{2-3}
ключа & Состояние PS & Состояние AS & \\
\hline
\hline
128 & $\hex{01}$ & $\hex{11}$ & Обязательна \\
192 & $\hex{02}$ & $\hex{12}$ & Необязательна\\
256 & $\hex{03}$ & $\hex{13}$ & Необязательна\\
\hline
\end{tabular}
\end{table}

При генерации ключей используется алгоритм \texttt{bign-sign}
со стандартными параметрами СТБ 34.101.45 (приложение Б), 
которые определяются неявно по уровню стойкости личного ключа. 

Команда может вызываться \addendum{при выборе файла} eSign в состояниях 
PS и AS:AT. В состоянии AS:AT команда может вызываться 
только авторизованным терминалом, в сертификате которого задано право
генерации ключей в терминальном режиме (см.~\ref{DATA.Access}).

Команда требует предварительной аутентификации по PIN. При вызове
команды \doubt{статус подтверждения} пароля PIN должен быть 
установлен.

Выполнение команды приводит к сбрасыванию статуса подтверждения пароля PIN.
Для установки статуса подтверждения пароля PIN 
необходимо либо подтвердить пароль PIN (см.~\ref{Oper.Descr.VerifyPIN}), 
либо повторно выполнить аутентификацию по PIN (см.~\ref{Oper.Seq.BPACE}).

Если при выполнении команды личный ключ с указанным в команде идентификатором
уже существует, то должен быть возвращен статус 
$\text{SW1} \parallel \text{SW2} = \hex{6984}$. 
При этом для генерации нового ключа старый ключ должен быть предварительно 
уничтожен командой <Terminate> (см.~\ref{Oper.Descr.Terminate}).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Деактивация личного ключа}
\label{Oper.Descr.DeactivateKey} 

Для деактивации личного ключа используется команда <Deactivate>.
\addendum{Команда определена в} таблице~\ref{Table.Oper.DeactivateKeyCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.DeactivateKeyCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\
\hline
\hline
INS & $\hex{04}$: деактивировать\\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{2100}$: 
деактивировать ключ, определяемый полем данных\\
\hline
CDF &  $\der(\hex{84}, X)$,   
где $X$ определяет идентификатор личного ключа 
(см. таблицу~\ref{Table.Oper.KeyRef})\\
\hline 
RDF & --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$: ключ деактивирован успешно. \\
%  & $\hex{6A88}$: cсылочные данные (ключ) не найдены \\
  & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Команда может вызываться \addendum{при выборе файла} eSign в состояниях 
PS и AS:AT. В состоянии AS:AT команда может вызываться 
только авторизованным терминалом, в сертификате которого задано право
деактивировать ключи (см.~\ref{DATA.Access}).

Команда требует предварительной аутентификации по PIN. 

Если ключ уже деактивирован, то должен быть возвращен статус
$\text{SW1} \parallel \text{SW2} = \hex{9000}$.

После деактивации личного ключа выполнение любых операций, 
требующих его использования, становится невозможным.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Деактивация PIN}
\label{Oper.Descr.DeactivatePIN} 

Для деактивации PIN (см.~\ref{OBJ.PWD}) используется команда <Deactivate>.
\addendum{Команда определена в} таблице~\ref{Table.Oper.DeactivatePINCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.DeactivatePINCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{04}$: деактивировать \\
\hline
P1 & $\hex{10}$: деактивировать пароль, определяемый P2\\
\hline
P2 & $\hex{03}$: PIN \\
\hline
CDF &  --- \\
\hline 
RDF & --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$: PIN деактивирован \addendum{успешно}\\
\cline{2-2}
  & Другое: см. таблицу~\ref{Table.Errors.General}\\
\hline
\end{tabular}
\end{table}

Команда может вызываться \addendum{при выборе файла} eSign в состояниях 
PS, AS:AT и \addendum{при выборе файла} eID в состоянии AS:AT. 
В состоянии AS:AT команда может вызываться только авторизованным терминалом, 
в сертификате которого задано право деактивировать пароль PIN
(см.~\ref{DATA.Access}).

Команда требует предварительной аутентификации по PIN или PUK. 

Если PIN уже деактивирован, то должен быть возвращен 
статус $\text{SW1} \parallel \text{SW2} = \hex{9000}$.

После деактивации PIN выполнение любых операций, 
требующих аутентификации по паролю PIN (см. таблицу~\ref{Table.Oper.List}), 
становится невозможным. 
При этом КТ переходит в состояние IS и мастер-файл 
становится \addendum{выбранным} файлом. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Изменение PIN}
\label{Oper.Descr.ChangePIN}

Для изменения PIN используется команда <Change reference data>.
\addendum{Команда определена в} таблице~\ref{Table.Oper.ChangePINCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.ChangePINCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & 	Описание \\
\hline
\hline
INS & $\hex{24}$: изменить данные\\
\hline
P1 & $\hex{00}$: задавать старое и новое значение пароля. \\
   & $\hex{01}$: задавать только новое значение пароля\\
\hline
P2 & $\hex{03}$: значение PIN \\
\hline
CDF & При $\text{P1}=\hex{00}$ старое и новое значение PIN в формате UTF8.\\
    & При $\text{P1}=\hex{01}$ новое значение PIN в формате UTF8\\
\hline 
RDF & 	 --- \\
\hline
$\text{SW1}\parallel\text{SW2}$ & 
 $\hex{9000}$: PIN изменен успешно. \\
  & Другое: произошла ошибка (см. таблицу~\ref{Table.Errors.General})\\
\hline
\end{tabular}
\end{table}

Команда может вызываться \addendum{при выборе файла} eSign в состояниях 
PS, AS:AT и \addendum{при выборе файла} eID в состоянии AS:AT. 
В состоянии AS:AT команда может вызываться только авторизованным терминалом, 
в сертификате которого задано право изменения пароля PIN
(см.~\ref{DATA.Access}).

Команда требует предварительной аутентификации по PIN. 

Выполнение команды приводит к сбрасыванию 
\doubt{статуса подтверждения} пароля PIN.
Для установки статуса подтверждения пароля PIN 
необходимо либо подтвердить пароль PIN (см.~\ref{Oper.Descr.VerifyPIN}), 
либо повторно выполнить аутентификацию по PIN (см.~\ref{Oper.Seq.BPACE}).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Инициализация алгоритма выработки подписи}
\label{Oper.Descr.SetDST}

Для инициализации алгоритма подписи используется команда     
<MSE: Set DST> (аббревиатура от <<Manage Security Environment: Set 
Digital Signature Template>). Команда задает личный ключ и алгоритм
хэширования, которые будут использоваться при выработке подписи.
%
\addendum{Команда определена в} таблице~\ref{Table.Oper.SetDSTCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.SetDSTCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{22}$: управление средой безопасности\\ 
\hline
$\text{P1} \parallel\text{P2}$ & $\hex{41B6}$: 
выбрать для алгоритма выработки подписи \\
\hline
CDF & 
$\der(\hex{84}, X) \parallel \der(\hex{80}, Y)$, 
где $X$ определяет идентификатор личного ключа (см. таблицу~\ref{Table.Oper.KeyRef}), 
а $Y$ определяет идентификатор используемого при выработке
подписи алгоритма хэширования 
и принимает значение $\hex{90}$ для алгоритма хэширования \texttt{belt-hash},  
$\hex{B0}$ для алгоритма хэширования \texttt{bash384} и 
$\hex{C0}$ для алгоритма хэширования \texttt{bash512} (см.~\ref{CRYPTO.StdAlg})\\
\hline 
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$: алгоритм инициализирован успешно. \\
  & $\hex{6283}$: личный ключ деактивирован. \\
  & $\hex{6984}$: личный ключ уничтожен. \\
%  & $\hex{6A88}$: cсылочные данные (ключ) не найдены \\
  & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

\if 0

\begin{table}[hbt]
\caption{Допустимые значения идентификаторов алгоритмов хэширования}
\label{Table.Oper.AlgRef}
\begin{tabular}{|c|c|c|}
\hline
Уровень стойкости ключа & Алгоритм хэширования  & Идентификатор  \\
\hline
\hline
128 & \texttt{belt-hash} & $\hex{90}$ \\
192 & \texttt{bash384} & $\hex{B0}$ \\
256 & \texttt{bash512} & $\hex{C0}$ \\
\hline
\end{tabular}
\end{table}

\fi


В компоненте CDF алгоритм хэширования \texttt{belt-hash}
может быть задан только совместно с личным ключом 
уровня стойкости $l=128$,
а алгоритмы хэширования \texttt{bash384} и \texttt{bash512}~--- 
с личными ключами уровней стойкости $l=192$ или $l=256$
соответственно.
Уровень стойкости алгоритма хэширования \texttt{bash} определяется 
неявно по уровню стойкости выбранного личного ключа.

Команда требует предварительной аутентификации по PIN. 
При вызове команды \doubt{статус подтверждения} 
пароля PIN должен быть установлен.
Для установки статуса подтверждения пароля PIN 
необходимо либо подтвердить пароль PIN (см.~\ref{Oper.Descr.VerifyPIN}), 
либо повторно выполнить аутентификацию по паролю PIN (см.~\ref{Oper.Seq.BPACE}).

Команда может вызываться \addendum{при выборе файла} eSign в 
состояниях PS и AS:AT. В состоянии AS:AT команда 
может вызываться только авторизованным терминалом,
в сертификате которого задано право 
выработки подписи в терминальном режиме (см.~\ref{DATA.Access}).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Инициализация алгоритма разбора токена ключа}
\label{Oper.Descr.SetCT}

Для инициализации алгоритма разбора токена ключа
используется команда <MSE: Set CT> 
(аббревиатура от <<Manage Security Environment: Set Confidentialy template>).
Команда задает личный ключ, который будет использоваться при разборе токена ключа.
\addendum{Команда определена в} таблице~\ref{Table.Oper.SetCTCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.SetCTCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{22}$: управление средой безопасности\\ 
\hline
$\text{P1} \parallel\text{P2}$ & $\hex{41B8}$: 
выбрать для алгоритма разбора токена ключа
(расшифрования ключа) \\
\hline
CDF & 
$\der(\hex{84}, X)$, 
где $X$ определяет идентификатор личного ключа
(см. таблицу~\ref{Table.Oper.KeyRef})\\
\hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$: алгоритм инициализирован успешно. \\
  & $\hex{6283}$: личный ключ деактивирован. \\
  & $\hex{6984}$: личный ключ уничтожен. \\
%  & $\hex{6A88}$: cсылочные данные (ключ) не найдены \\
  & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Команда может вызываться \addendum{при выборе файла} eSign в 
состояниях PS и AS:AT. В состоянии AS:AT команда 
может вызываться только авторизованным терминалом,
в сертификате которого задано право 
разбора токена ключа в терминальном режиме (см.~\ref{DATA.Access}).

Команда требует предварительной аутентификации по PIN. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Инициализация протокола BAUTH}
\label{Oper.Descr.SetBAUTH}

Для инициализации протокола BAUTH используется команда <MSE: Set AT> 
(аббревиатура от <<Manage Security Environment: Set Authentication Template>>).
\addendum{Команда определена в} таблице~\ref{Table.Oper.SetBAUTHCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.SetBAUTHCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{22}$: управление средой безопасности\\ 
\hline
$\text{P1} \parallel\text{P2}$ & $\hex{C1A4}$: выбрать и 
инициализировать протокол BAUTH с взаимной 
аутентификацией.\\ 
 & $\hex{81A4}$: выбрать и инициализировать протокол BAUTH с 
односторонней аутентификацией\\
\hline
CDF & Объект данных 
$\der(\hex{80}, X)$, где~$X$~--- 
закодированный объектный идентификатор (без поля тега и поля 
длины) протокола (см. приложение~\ref{ASN}).\\
 & Объект данных $\der(\hex{85}, X)$, 
где~$X$ определяет хэш-значение запроса аутентификации (см.~\ref{FLOW}).\\
 & Объект данных~$X$, который является 
закодированным значением типа \verb|AuthAuxData| (см.~\ref{DATA.Optional}). 
Используется в команде <Verify> (см.~\ref{Oper.Descr.VerifyData}) 
для получения значений дополнительных атрибутов DocumentValidity, 
AgeVerification, RegionVerification. В~$X$ 
обязательно должны быть включены параметры атрибута DocumentValidity\\
\hline 
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$: протокол инициализирован успешно. \\
  & Другое: см. таблицу~\ref{Table.Errors.General}\\
\hline
\end{tabular}
\end{table}

В компоненте CDF все \doubt{объекты данных} являются обязательными, 
они должны передаваться с помощью одной команды, 
т.е. использование цепочки команд <MSE: Set AT> не допускается. 
При этом порядок следования объектов данных в компоненте CDF не важен. 

\if 0
В случае если для команды <MSE: Set AT> в компоненте CDF необходимо 
передать несколько \doubt{объектов данных}, то они должны передаваться с помощью 
одной команды, т.е. использование цепочки команд <MSE: Set AT> не 
допускается. При этом порядок следования объектов данных в компоненте CDF 
не важен. 
\fi

Команда может вызываться \addendum{при выборе мастер-файла} в состоянии PS 
непосредственно после выполнения протокола BPACE (см.~\ref{Oper.Descr.GABPACE}).

%\doubt{Для использования прикладной программы eID  должен инициализироваться
%протокол BAUTH с взаимной  аутентификацией.}

При успешном выполнении протокола BAUTH дата, которая передается в команде 
для проверки срока действия КТ, может использоваться для обновления 
даты, которая хранится на КТ (см.~\ref{OBJ.Date}). 

\subsection{Инициализация протокола BPACE}
\label{Oper.Descr.SetBPACE}

Для инициализации протокола BPACE используется команда
<MSE: Set AT> (аббревиатура от <<Manage Security Environment: Set 
Authentication Template>>). 
\addendum{Команда определена в} таблице~\ref{Table.Oper.SetBPACECmd}.

\begin{table}[h]
\caption{}\label{Table.Oper.SetBPACECmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{22}$: управление средой безопасности\\ 
\hline
$\text{P1} \parallel\text{P2}$ & $\hex{C1A4}$: выбрать и 
инициализировать протокол BPACE\\ 
\hline
CDF & Обязательный объект данных 
$\der(\hex{80}, X)$, где~$X$~--- 
закодированный объектный идентификатор (без поля тега и поля 
длины) протокола (см. приложение~\ref{ASN}).\\
& Обязательный объект данных $\der(\hex{83}, X)$, 
где $X$ определяет, какой пароль будет использоваться в протоколе: 
$\hex{02}$~--- CAN,  $\hex{03}$~--- PIN, 
$\hex{04}$~--- PUK.\\
 & Необязательный объект данных~$X$, который является 
закодированным значением типа \verb|CertHAT| (см.~\ref{DATA.Access}). 
Используется для установки прав на доступ 
к данным и сервисам определенной прикладной программы КТ.
Для каждой прикладной программы используется свой объект.
Отсутствие объекта для определенной прикладной
программы означает отсутствие прав доступа к ней. \\
 & Необязательный объект данных $\der(\hex{53}, X)$, 
где $X$ принимает значения от 0 до 255 и 
определяет количество последовательных подписей, 
которые могут быть выработаны прикладной программы eSign
в текущем сеансе без повторного подтверждения владельца КТ.
Значение 0 означает, что может быть выработано 
неограниченное количество последовательных подписей. 
Если данный объект не задан, то \addendum{прикладная программа eSign 
использует} значение по умолчанию, равное 1 \\
\hline 
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
  $\hex{9000}$: протокол инициализирован успешно,
количество возможных попыток аутентификации равно начальному значению; \\
 & $\hex{63CX}$: протокол инициализирован успешно,
значение \texttt{X} содержит количество 
оставшихся попыток аутентификации, которое не равно начальному значению
(при $\texttt{X} = 1$ пароль приостановлен, а при $\texttt{X} = 0$~--- заблокирован);\\
& $\hex{6984}$: пароль деактивирован. \\
 & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

В случае если для команды <MSE: Set AT> в компоненте CDF необходимо 
передать несколько объектов данных, то они должны передаваться с помощью 
одной команды, т.е. использование цепочки команд <MSE: Set AT> не 
допускается. При этом порядок следования объектов данных в компоненте CDF 
не важен. Например, для протокола BPACE, использующего PIN, компонент CDF, 
содержащий только обязательные объекты данных, может иметь вид: 
$\text{CDF} = 
\der(\hex{83}, \hex{03}) \parallel 
\der(\hex{80}, X)$, где~$X$~--- закодированный (без поля тега и 
поля длины) объектный идентификатор протокола BPACE (см. СТБ 34.101.66).

Закодированные значения типа \verb|CertHAT|, передаваемые в компоненте CDF, 
должны использоваться в протоколе BPACE как приветственное сообщение КП
(см.~\ref{CRYPTO.BPACE}).
\addendum{Если} передается несколько таких значений,
то при формировании приветственного сообщения они 
должны объединяться в порядке следования в компоненте CDF.
Если же не передается ни одного значения, то в качестве 
приветственного сообщения должно использоваться пустое слово. 
 
%Для разблокировки или активации PIN (см.~\ref{OBJ.PWD})
%при инициализации BPACE в команде <MSE: Set AT> требуется использовать PUK 
%(см.~\ref{OBJ.PWD}).
%До выполнения протокола BPACE должна быть выбрана прикладная 
%программа КТ, пароль которой будет передаваться в команде <MSE: Set AT>. 
%Для этого должна быть вызвана команда <Select File> с нужным 
%идентификатором прикладной программы (AID, см. приложение~\ref{FILES}). 

Для возобновления PIN (см.~\ref{OBJ.PWD}) требуется 
использовать при инициализации BPACE пароль CAN. 
Тип пароля, который должен использоваться при 
инициализации BPACE для возможности выполнения различных 
операций, определяется в таблице~\ref{Table.Oper.List}.

При инициализации BPACE задаются разрешения 
владельца на доступ к сервисам и данным  
КТ, а также количество подписей, которые могут быть выработаны 
в текущем сеансе без повторного подтверждения владельцем КТ пароля PIN.

Команда может вызываться в любом из состояний \addendum{при выборе} мастер-файла.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Обновление данных}
\label{Oper.Descr.Update}

Для обновления данных элементарных файлов используется команда <Update Binary>.
\addendum{Команда определена в} таблице~\ref{Table.Oper.UpdateCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.UpdateCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\
\hline
\hline
INS & $\hex{D6}$: обновление бинарных данных\\
\hline
P1 & Старший байт смещения, с которого \addendum{будут} перезаписываться данные 
(старший бит должен быть равен нулю) \\
\hline
P2 & Младший байт смещения, с которого будут перезаписываться данные \\
\hline
CDF & Записываемые данные \\
\hline 
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$: данные перезаписаны успешно. \\
 & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Размер данных, которые нужно записать, определяется компонентом Lс команды 
(см.~\cite{APDU}).

Команда может вызываться в состояниях PS, AS:AT 
\addendum{при выборе файла} eSign и в состоянии 
AS:AT \addendum{при выборе файла} eID.
В состоянии AS:AT команда может вызываться только 
авторизованным терминалом, в сертификате которого
задано право записи в соответствующий элементарный 
файл (см.~\ref{DATA.Access}).

Для обновления элементарных файлов \addendum{прикладной программы} eSign 
\addendum{требуется предварительная аутентификация} по PIN.

Для обновления элементарных файлов \addendum{прикладной программы} eID 
\addendum{требуется предварительная аутентификация} по CAN или PIN.

Файл, в который записываются данные, должен быть предварительно
выбран (см. \ref{Oper.Descr.SelectEF}).
Запись может быть произведена только в те файлы, для которых 
нет ограничений по записи при текущем состоянии КТ. 
При попытке записи в файлы, доступ к которым ограничен, 
должен возвращаться статус $\text{SW1} \parallel\text{SW2} = \hex{6982}$. 

\subsection{Переключение между соединениями}
\label{Oper.Descr.SetCS}

Для переключения между защищенным соединением,
устанавливаемым между КТ и КП после выполнения 
протокола BPACE, и соединением, 
устанавливаемым между КТ и терминалом после выполнения 
протокола BAUTH, используется команда <MSE: Set CS> (аббревиатура от <<Manage 
Security Environment: Set Context Switch>).
\addendum{Команда определена в} таблице~\ref{Table.Oper.SetCSCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.SetCSCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{22}$: управление средой безопасности\\ 
\hline
$\text{P1} \parallel\text{P2}$ & $\hex{01A4}$: 
переключиться между соединениями \\
\hline
CDF & 
$\der(\hex{E1}, \der(\hex{81}, X))$, 
где $X$ определяет идентификатор
соединения и принимает значение $\hex{00}$ для
переключения на защищенное соединение <<КП -- КТ>>
и значение $\hex{01}$ для переключения на защищенное
соединение <<терминал -- КТ>>\\ 
\hline 
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$: переключение между соединениями выполнено успешно. \\
 & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Команда может вызываться \addendum{при выборе файлов} eID \addendum{или} eSign
в состоянии AS.

Команда требует предварительной аутентификации по PIN или PUK.

Переключение между соединениями может понадобиться
при подтверждении (см.~\ref{Oper.Descr.VerifyPIN}), 
изменении (см.~\ref{Oper.Descr.ChangePIN})
или разблокировке (см.~\ref{Oper.Descr.UnblockPIN}) PIN.

После успешного выполнения команды \addendum{мастер-файл становится выбранным}. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Подтверждение PIN}
\label{Oper.Descr.VerifyPIN}

Для подтверждения PIN используется команда <Verify>. 
\addendum{Команда определена в} таблице~\ref{Table.Oper.VerifyPINCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.VerifyPINCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{20}$: проверить данные\\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{0003}$: 
проверка пароля PIN\\
\hline
CDF & пароль PIN в формате UTF8 \\
\hline 
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$: аутентификация успешна;\\
 & $\hex{63CX}$: аутентификация неуспешна, значение \texttt{X} содержит количество 
оставшихся попыток аутентификации (при $\texttt{X} = 1$ пароль 
приостановлен, а при $\texttt{X} = 0$~--- заблокирован).\\
& $\hex{6984}$: пароль деактивирован. \\
 & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Команда может вызываться \addendum{при выборе файла} eSign
в состояниях PS и AS:CP.

Команда требует предварительной аутентификации по PIN.

Успешное выполнение команды устанавливает 
\doubt{статус подтверждения} пароля PIN.
В свою очередь, неуспешное выполнение команды 
сбрасывает данный статус.

Команду может потребоваться вызвать после сброса статуса
подтверждения пароля PIN, который происходит 
после выработки определенного количества подписей (см.~\ref{Oper.Descr.Signature}),
генерации ключевой пары (см.~\ref{Oper.Descr.GenKeys}),
изменения пароля PIN (см.~\ref{Oper.Descr.ChangePIN}),
уничтожение личного ключа (см.~\ref{Oper.Descr.Terminate}).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Проверка дополнительного атрибута}
\label{Oper.Descr.VerifyData}

Для проверки дополнительных атрибутов DocumentValidity, AgeVerification, 
RegionVerification (см.~\ref{DATA.Optional}) используется команда  <Verify>. 
\addendum{Команда определена в} таблице~\ref{Table.Oper.VerifyDataCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.VerifyDataCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{20}$: проверить данные\\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{8000}$: 
проверить дополнительный атрибут\\
\hline
CDF & Закодированный идентификатор дополнительного атрибута 
(см.~\ref{DATA.Optional}). 
Может принимать одно из значений 
\verb|id-DocumentValidity|, \verb|id-AgeVerification|, \verb|id-PlaceVerification| 
(см. приложение~\ref{ASN})\\
\hline 
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$: атрибут проверен успешно.\\
 & $\hex{6300}$: атрибут проверен неуспешно.\\
 & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Команда может вызываться \addendum{при выборе файла} eID в состоянии AS:AT
авторизованным терминалом, в сертификате которого задано право
проверки соответствующего атрибута (см.~\ref{DATA.Access}).  

Команда требует предварительной аутентификации по CAN или PIN.

Установка проверяемых командой данных производится 
при инициализации протокола BAUTH (см.~\ref{Oper.Descr.SetBAUTH}).  

Для команды должен использоваться $\text{CLA}=\hex{84}$ 
(прикладной класс для защищенного соединения без использования цепочки 
команд). 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Проверка сертификата}
\label{Oper.Descr.VerifyCert}

Для импорта и проверки сертификата при аутентификации терминала 
по протоколу BAUTH используется команда 
<PSO: Verify Certificate> (аббревиатура от <<Perform Security 
Operation: Verify Certificate>>).
\addendum{Команда определена в} таблице~\ref{Table.Oper.VerifyCertCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.VerifyCertCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\ 
\hline
\hline
INS & $\hex{2A}$: управление средой безопасности \\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{00BE}$: проверить 
сертификат открытого ключа \\ 
\hline
CDF  & Закодированное значение компонента \verb|certificateBody|, определяющего тело 
облегченного сертификата (см.~\ref{CERTS.Format}).\\
 & Закодированное значение компонента \verb|signature|, определяющего подпись 
облегченного сертификата (см.~\ref{CERTS.Format})\\
\hline 
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$: сертификат проверен успешно. \\
 & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

В компоненте CDF команды передаются тело и подпись облегченного сертификата.
Для их передачи может использоваться цепочка из двух команд 
<PSO: Verify Certificate>, первая из которых содержит тело 
облегченного сертификата, 
а вторая~--- подпись облегченного сертификата.

Для передачи нескольких сертификатов, составляющих маршрут 
сертификации, должен использоваться 
последовательный вызов команд <PSO: Verify Certificate>. 
При этом если какой-либо сертификат передается цепочкой команд, 
то для него должна использоваться своя цепочка.

Открытый ключ, используемый при проверке сертификата после его передачи в
КТ, извлекается из сертификата, который хранится на КТ или который был 
импортирован в КТ предшествующим успешным вызовом 
команды <PSO: Verify Certificate> (см.~\ref{CERTS.Path}).

% todo?: пояснить процедуру проверки сертификата:
% - на КТ хранится сертификат/ОК доверенного УЦ; ОК помещается в буфер;
% - при проверке следующего сертификата из цепочки используется ОК из буфера,
% - при успехе проверки ОК из сертификата попадает в буфер, 
%   иначе буфер \doubt{очищается};
% - при последующей работе (выполнении шагов протокола BAUTH) используется 
%   ОК из буфера.

Команда может вызываться \addendum{при выборе} мастер-файла
в состоянии PS непосредственно после 
инициализации протокола BAUTH (см.~\ref{Oper.Descr.SetBAUTH}).

Команда требует предварительной аутентификации по CAN, PIN или PUK. 
Если аутентификация выполнялась по CAN,
то в сертификате терминала должно быть установлено 
право доступа по паролю CAN (см.~\ref{DATA.Access}).

Если сертификат является недействительным, то должен 
возвращаться статус 
$\text{SW1} \parallel \text{SW2} = \hex{6A80}$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Проверка статуса подтверждения PIN}
\label{Oper.Descr.VerifyAuth}

Для проверки статуса подтверждения PIN используется команда <Verify>.
\addendum{Команда определена в} таблице~\ref{Table.Oper.VerifyAuthCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.VerifyAuthCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{20}$: проверить данные\\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{0003}$: проверить статус подтверждения пароля PIN \\
\hline
CDF & --- \\
\hline 
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$: 
 статус подтверждения пароля PIN установлен.\\
 & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Команда может вызываться \addendum{при выборе файла} eSign в состояниях 
PS и AS:AT. 

Команда требует предварительной аутентификации по PIN.

Если статус подтверждения пароля PIN не установлен, то должен 
возвращаться статус $\text{SW1} \parallel \text{SW2} = \hex{6982}$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Разблокировка PIN}
\label{Oper.Descr.UnblockPIN}

Для разблокировки PIN используется команда <Reset Retry Counter>.
\addendum{Команда определена в} таблице~\ref{Table.Oper.UnblockPINCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.UnblockPINCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & 	Описание \\
\hline
\hline
INS & $\hex{2С}$: разблокировать PIN\\
\hline
%P1 & $\hex{02}$: разблокировать PIN с его изменением\\
P1 & $\hex{03}$: разблокировать PIN без его изменения\\
\hline
P2 & $\hex{00}$: PIN выбран неявно\\
\hline
%CDF & при $\text{P1} = \hex{02}$ содержит новое значение PIN в формате UTF8;\\
% & при $\text{P1} = \hex{03}$ не задается \\
  & --- \\
\hline 
RDF & 	 --- \\
\hline
$\text{SW1}\parallel\text{SW2}$ & $\hex{9000}$: 
разблокировка PIN была выполнена успешно.\\
& Другое: произошла ошибка (см. таблицу~\ref{Table.Errors.General}) \\
\hline
\end{tabular}
\end{table}

Команда может вызываться \addendum{при выборе файла} eSign в состояниях 
PS, AS:AT и \addendum{при выборе файла} eID в состоянии AS:AT. 
В состоянии AS:AT команда может вызываться 
только авторизованным терминалом,
в сертификате которого задано право разблокировать 
пароль PIN (см.~\ref{DATA.Access}).

Команда требует предварительной аутентификации по PUK. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Разбор токена ключа}
\label{Oper.Descr.Decipher}

Для разбора токена ключа используется 
команда <PSO: Decipher> (аббр. от <<Perform Security Operation: Decipher>>).
\addendum{Команда определена в} таблице~\ref{Table.Oper.DecipherCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.DecipherCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\ 
\hline
\hline
INS & $\hex{2A}$: управление средой безопасности \\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{8086}$: расшифровать
данные \\ 
\hline
CDF & Объект $X=I \| Y$, где $I$~--- заголовок транспортируемого ключа, 
$Y$~--- токен транспортируемого ключа \\
\hline 
RDF &  расшифрованный ключ \\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$: 
токен разобран успешно.\\
& Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

При разборе токена используется алгоритм $\texttt{bign-keytransport}^{-1}$
(см.~\ref{CRYPTO.StdAlg})
со стандартными параметрами СТБ 34.101.45 (приложение Б),
которые определяются неявно по личному ключу,
выбранному при инициализации алгоритма (см.~\ref{Oper.Descr.SetCT}).
Длина в битах транспортируемого ключа должна принимать значения
от 128 до 256 и не должна быть меньше уровня стойкости 
личного ключа, используемого для разбора токена.

В компоненте CDF команды должен передаваться токен ключа, 
сформированный с нулевым заголовком ключа. 

Команда может вызываться \addendum{при выборе файла} eSign в состояниях 
PS и AS:AT непосредственно после успешной инициализации 
алгоритма разбора токена (см.~\ref{Oper.Descr.SetCT}).

%Порядок, в котором должна вызываться команда, 
%определяется в~\ref{Oper.Seq.Decipher}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Сброс статуса подтверждения PIN}
\label{Oper.Descr.VerifyDeauth}

Для сброса статуса подтверждения пароля PIN используется команда <Verify>.
\addendum{Команда определена в} таблице~\ref{Table.Oper.VerifyDeauthCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.VerifyDeauthCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{20}$: проверить данные\\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{FF03}$: сбросить статуса подтверждения
пароля PIN  \\
\hline
CDF & ---  \\
\hline 
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$ 
статус подтверждения пароля PIN сброшен успешно.\\
& Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Команда может вызываться \addendum{при выборе файла} eSign  
в состояниях PS и AS:AT.

Команда требует предварительной аутентификации по PIN.

Успешное выполнение команды сбрасывает статус подтверждения пароля PIN,
а неуспешное~--- не изменяет его статус.

Если статус подтверждения пароля PIN уже сброшен, то должен быть возвращен статус
$\text{SW1} \parallel \text{SW2} = \hex{9000}$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Чтение данных}
\label{Oper.Descr.Read}

Для чтения данных из элементарных файлов используется команда <Read Binary>.
\addendum{Команда определена в} таблице~\ref{Table.Oper.ReadCmd}.

\begin{table}[hbt]
\caption{}\label{Table.Oper.ReadCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{B0}$: чтение бинарных данных \\
\hline
P1 & Старший байт смещения, с которого будут читаться данные (старший бит 
должен быть равен нулю) \\
\hline
P2 & Младший байт смещения, с которого будут читаться данные\\
\hline
CDF &  --- \\
\hline 
RDF & 	Прочитанные данные \\
\hline
$\text{SW1} \parallel\text{SW2}$ & 
$\hex{9000}$: данные прочитаны успешно. \\
& Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Размер данных, которые нужно прочитать, определяется компонентом 
Le (см.~\cite{APDU}).

Команда может вызываться в состояниях PS, AS:AT 
\addendum{для файлов} eSign и в состоянии AS:AT \addendum{для файлов} eID.
В состоянии AS:AT команда может вызываться только 
авторизованным терминалом, в сертификате которого
задано право чтения соответствующего файла или группы данных
(см.~\ref{DATA.Access}).

Для чтения элементарных файлов \addendum{прикладной программы} eSign 
\addendum{требуется предварительная аутентификация} по PIN.

Для чтения элементарных файлов \addendum{прикладной программы} eID 
\addendum{требуется предварительная аутентификация} по CAN или PIN.

Элементарный файл, из которого читаются данные, должен быть предварительно 
выбран (см.~\ref{Oper.Descr.SelectEF}). Прочитаны могут быть только те данные, 
для которых нет ограничений по чтению при текущем состоянии КТ (см.~\ref{DATA.Access}). 
При попытке чтения данных, доступ к которым ограничен, должен возвращаться 
статус $\text{SW1} \parallel \text{SW2} = \hex{6982}$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Уничтожение личного ключа}
\label{Oper.Descr.Terminate}

Для уничтожения личного ключа используется команда <Terminate>.
\addendum{Команда определена в} таблице~\ref{Table.Oper.TerminateCmd}.

\begin{table}[ht]
\caption{}\label{Table.Oper.TerminateCmd}
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\
\hline
\hline
INS & $\hex{E6}$: уничтожить личный ключ \\
\hline
$\text{P1} \parallel\text{P2}$ & $\hex{2100}$:
идентификатор личного ключа задается в поле данных\\
\hline
CDF &  $\der(\hex{B6},\der(\hex{84}, X))$,
%$\der(\hex{84}, X)$,  
где $X$ определяет идентификатор личного ключа
(см. таблицу~\ref{Table.Oper.KeyRef})\\ 
\hline 
RDF & ---  \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$: ключ уничтожен успешно.\\
% & $\hex{6A88}$: ссылочные данные (ключ) не найдены\\
 & Другое: см. таблицу~\ref{Table.Errors.General} \\
\hline
\end{tabular}
\end{table}

Команда может вызываться \addendum{при выборе файла} eSign в состояниях 
PS и AS:AT. В состоянии AS:AT команда может вызываться только
авторизованным терминалом, в сертификате которого задано право
уничтожать ключи (см.~\ref{DATA.Access}).
В каждом из состояний могут быть уничтожены только те ключи, которые
были сгенерированы в данном состоянии (см.~\ref{Oper.Descr.GenKeys}).

Команда требует предварительной аутентификации по PIN. 
При вызове команды \doubt{статус подтверждения} пароля PIN 
должен быть установлен.

Выполнение команды приводит к сбрасыванию статуса подтверждения пароля PIN.
Для установки статуса подтверждения пароля PIN 
необходимо либо подтвердить пароль PIN (см.~\ref{Oper.Descr.VerifyPIN}), 
либо повторно выполнить аутентификацию по PIN (см.~\ref{Oper.Seq.BPACE}).

При попытке уничтожить ключ, который не был сгенерирован
или который был уничтожен ранее, должен возвращаться 
статус $\text{SW1} \parallel \text{SW2} = \hex{9000}$.