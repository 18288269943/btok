\chapter{Состояния криптографического токена}\label{STATES}

КТ может находиться в следующих состояниях:
%
\begin{itemize}
\item[1)]
начальное состояние (IS);
\item[2)]
состояние после успешной аутентификации по паролю (PS);
\item[3)]
состояние после успешной аутентификации терминала (AS).
\end{itemize}

В состоянии IS взаимодействие с КТ осуществляется без использования 
защищенного соединения. В состоянии PS используется 
защищенное соединение <<КП~--- КТ>>, 
а в состоянии AS~--- защищенные соединения <<КП~--- КТ>> 
и <<терминал~--- КТ>> (см.~\ref{CRYPTO.SM}).

В состояние IS токен переходит сразу после включения 
или из состояний PS и AS при принудительном закрытии защищенного соединения 
<<КП~--- КТ>> (см.~\ref{CMDS.SM}). 
%
При переходе в IS защищенное соединение <<терминал~--- КТ>>, 
если оно было установлено ранее, закрывается.
В состоянии IS доступ к прикладным программам eID и eSign запрещен.

В состояние PS токен может перейти из любого состояния 
после успешной парольной аутентификации, 
т.~е. после успешного выполнения протокола BPACE,
а также из состояния AS при принудительном закрытии 
защищенного соединения <<терминал~--- КТ>> (см.~\ref{CMDS.SM}).
%
При переходе в PS существующее защищенное соединение <<КП~--- КТ>>  
переустанавливается, а защищенное соединение <<терминал~--- КТ>> 
закрывается.

В состоянии PS может использоваться только прикладная программа eSign
с правами, заданными при инициализации протокола BPACE 
(см.~\ref{Oper.Descr.SetBPACE}).

В состояние AS токен переходит из состояния PS 
после успешной аутентификации терминала, т.~е. 
после успешного выполнения протокола BAUTH 
(с односторонней или взаимной аутентификацией).
%
При переходе в состояние активным устанавливается 
защищенное соединение <<терминал~--- КТ>>.
В состоянии AS поддерживается переключение  
между защищенными соединениями <<терминал~--- КТ>> и <<КП~--- КТ>>.
Переключение между соединения может потребоваться, 
например, для подтверждения пароля PIN (см.~\ref{Oper.Descr.VerifyPIN}), 
при котором ввод пароля осуществляется через КП. 
Состояние с активным защищенным соединением <<терминал~--- КТ>>
обозначается через AS:AT, 
а состояние с активным защищенным соединением <<КП~--- КТ>>~--- 
через AS:CP. 

В состоянии AS могут использоваться прикладные программы eSign и eID.
Доступ к программам определяется правами, 
заданными при инициализации протокола BPACE (см.~\ref{Oper.Descr.SetBPACE}), 
и маршрутом сертификации терминала (см.~\ref{DATA.Access}).

%При завершении работы с КТ (например, 
%после отключения питания аппаратного КТ)
%защищенные соединения автоматически закрываются.

