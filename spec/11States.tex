\chapter{Состояния криптографического токена}\label{STATES}

КТ может находится в следующих состояниях:
%
\begin{itemize}
\item[1)]
начальное состояние (IS);
\item[2)]
состояние после успешной аутентификации по паролю (PS);
\item[3)]
состояние после успешной аутентификации терминала (AS).
\end{itemize}

В состоянии IS взаимодействие с КТ осуществляется без использования 
защищенного соединения. В свою очередь, в состоянии PS взаимодействие 
с КТ производится с использованием защищенного соединения <<КП~--- КТ>>, 
а в состоянии AS~--- с использованием защищенных соединений <<КП~--- КТ>> 
и <<терминал~--- КТ>> (см.~\ref{CRYPTO.SM}).

В состояние IS токен переходит сразу после включения.
Дополнительно КТ переходит в состояние IS из состояний PS и AS
при принудительном закрытии защищенного соединения <<КП~--- КТ>> (см.~\ref{CMDS.SM}).
При переходе в IS защищенное соединения <<терминал~--- КТ>>, 
если оно было установлено ранее, закрывается.
В состоянии IS доступ к прикладным программам eID и eSign запрещен.

В состояние PS токен может перейти из любого состояния 
после успешной аутентификации по паролю, 
т.е. после успешного выполнения протокола BPACE,
а также из состояния AS при принудительном закрытии 
защищенного соединения <<терминал~--- КТ>> (см.~\ref{CMDS.SM}).
Если при переходе в состояние PS защищенное соединение <<КП~--- КТ>> 
уже было установлено ранее, то оно переустанавливается. 
Если же при переходе в состояние PS дополнительно было установлено 
защищенное соединение <<терминал~--- КТ>>, то оно закрывается.

В состоянии PS может использоваться только прикладная программа eSign
с правами, заданными при инициализации протокола BPACE 
(см.~\ref{Oper.Descr.SetBPACE}).

В состояние AS токен переходит из состояния PS 
после успешной аутентификации терминала, т.е. 
после успешного выполнения протокола BAUTH 
(с односторонней или взаимной аутентификацией).
При переходе в состояние активным устанавливается 
защищенное соединение <<терминал~--- КТ>>.
В состоянии AS поддерживается переключение  
между защищенными соединениями <<терминал~--- КТ>> и <<КП~--- КТ>>.
Переключение между защищенными соединения может потребоваться, 
например, для подтверждения пароля PIN (см.~\ref{Oper.Descr.VerifyPIN}), 
при котором ввод пароля осуществляется через КП. 
Состояние с активным защищенным соедиением <<терминал~--- КТ>>
обозначается через AS:TA, 
а состояние с активным защищенным соедиением <<КП~--- КТ>>~--- AS:CP. 

В состоянии AS могут использоваться прикладные программы eSign и eID
с правами, заданными при инициализации протокола 
BPACE (см.~\ref{Oper.Descr.SetBPACE}) и в сертификате терминала,
заверенном цепочкой УЦ (см.~\ref{DATA.Access}).

%При завершении работы с КТ (например, 
%после отключения питания аппаратного КТ)
%защищенные соединения автоматически закрываются.

