\chapter{Объекты}\label{OBJ}

\section{Генератор случайных или псевдослучайных чисел}\label{OBJ.RNG}

В состав КТ должен входить физический генератор случайных чисел.
Генератор должен удовлетворять требованиям СТБ 34.101.27 или другого 
профильного ТНПА. Генератор должен использоваться для создания личных и 
секретных ключей и может использоваться для создания синхропосылок. 

Вместо генератора случайных чисел может использоваться его аналог~--- алгоритм 
генерации псевдослучайных чисел, определенный в СТБ 34.101.47 или в другом 
ТНПА. Входные данные алгоритма генерации должны включать долговременный 
секретный ключ и уникальную синхропосылку.
%
Уровень стойкости алгоритмов, в которых планируется использовать 
генерируемые ключи, должен соответствовать длине ключа алгоритма генерации.

\section{Таймер}\label{OBJ.Date}

Для определения даты на КТ может быть установлен аппаратный таймер, либо, 
если аппаратного таймера нет, текущая дата может приближенно оцениваться по 
реквизитам входящих сертификатов или по другим данным, передаваемым на КТ 
от терминала. Например, текущая дата всегда позже даты выпуска очередного 
сертификата терминала, признанного КТ действительным.

При отсутствии таймера оценка текущей даты должна устанавливаться при выпуске 
КТ в обращение равной дате выпуска. 

\section{Пароли}\label{OBJ.PWD}

КТ должен поддерживать три пароля: PIN, CAN, PUK.
Пароли используются в протоколе BPACE (см.~\ref{CRYPTO.BPACE})
и являются общими для всех прикладных программ КТ.

Пароль PIN (от Personal Identification Number)
представляет собой случайное число из 6 десятичных цифр,
известное только владельцу КТ. Используется для контроля доступа к данным и 
прикладным программам КТ.  

PIN снабжается счетчиком попыток, который первоначально равен 3. При 
неверном вводе PIN счетчик уменьшается на 1. Если счетчик достигает 
значения 1, то PIN приостанавливается и далее требуется ввести CAN. 
Ввод CAN не изменяет счетчик. При верном CAN пароль PIN возобновляется~--- 
его снова можно ввести. При неверном CAN доступ к КТ временно блокируется. 
Если счетчик попыток достигает значения 0, то PIN блокируется. 

\if0
\begin{note}
Примечание -- Блокировку КТ после неверного CAN рекомендуется выполнять не 
менее чем на 1 секунду. Если таймер отсутствует, то для блокировки можно 
организовать вычисления, которые займут нужное время. 
\end{note}
\fi

PIN может быть разблокирован вводом верного PUK. Однако если при 
заблокированном PIN пароль PUK вводится неверно 10 раз, то PIN блокируется 
навсегда.

При разблокировке PIN и вводе верного PIN значение счетчика попыток 
устанавливается в первоначальное. После ввода верного PIN он  
может быть изменен. 

PIN может быть деактивирован и повторно активирован.
Первоначально PIN является активированным. При деактивации
PIN доступ к операциям и данным, требующим аутентификации по PIN, невозможен.

Пароль CAN (от Card Access Number) представляет собой число из 6 десятичных 
цифр, которое не может быть вычислено на основании общей информации о КТ 
(например, серийном номере) или его владельце. Может быть напечатан на корпусе 
КТ или указан в сопроводительных документах. 

Пароль CAN не может быть заблокирован или изменен. Он используется для защиты 
от атак типа <<отказ в обслуживании>>: защита состоит в требовании ввести CAN перед 
последней проверкой PIN. Дополнительно CAN может использоваться для 
получения доступа к функциям и данным прикладной программы eID 
авторизованным терминалом, т.~е. терминалом, который был успешно 
аутентифицирован с помощью протокола BAUTH (см.~\ref{CRYPTO.BAUTH}) и в 
сертификате которого установлено соответствующее право (см.~\ref{DATA.Access}). 

Пароль PUK (от PIN Unlock Key) представляет собой случайное число из 10 
десятичных цифр, известное только владельцу КТ. PUK не может быть заблокирован 
или изменен. Используется для разблокировки PIN. Дополнительно может использоваться 
для деактивации и активации PIN.

\section{Личные ключи}\label{OBJ.Keys}

На КТ обязательно хранится личный ключ КТ, который используется 
для аутентификации КТ перед терминалом. Ключ устанавливается при выпуске
КТ в обращение вместе с сертификатом соотвествующего открытого ключа. 
Процедуры выпуска КТ должны гарантировать, что ключ сохраняется только в 
пределах криптографической границы токена. К личному ключу КТ можно обратиться 
только косвенно, через выполнение протокола аутентификации. Ключ не может быть 
прочитан с КТ или изменен. 

Дополнительно, на КТ могут хранится личные ключи, 
которые используются в прикладной программе eSign для выработки 
подписи и/или разбора токена ключа.
Личные ключи eSign генерируются средствами КТ при эксплуатации
КТ и никому не известны. 
Поддерживается одновременное использование нескольких личных ключей, 
соответствующих различным уровням стойкости ключа и режимам
использования КТ.
Ключи, сгенерированные в базовом режиме, не могут использоваться 
в терминальном и наоборот.
К личному ключу владельца можно обратиться только по идентификатору, 
личный ключ владельца не может быть прочитан с КТ, 
он может быть уничтожен и изменен.

\if0
todo: 
Предусмотрены 6 ключей, которым назначены идентификаторы 
\hex{01}, \hex{02}, \hex{03}, \hex{11}, \hex{12}, \hex{13}.
Первые 3 ключа -- базовый режим, последние 3 -- терминальный.
Второй символ идентификатора -- уровень стойкости.

\begin{note}
\doubt{Примечание}~---
При идентификации личных ключей КТ, соответствующих СТБ 34.101.79,
атрибут должен состоять из одного~байта.
\end{note}

\begin{note}
\doubt{Примечание}~---
Личные ключи eSign, соответствующие СТБ 34.101.79, должны быть неизвлекаемые,
значение атрибута~\verb|CKA_SENSITIVE| должно быть~\verb|CK_TRUE| и
не может быть изменено.
\end{note}

\begin{note}
\doubt{Примечание}~---
Личные ключи eSign, соответствующие СТБ 34.101.79, должны быть неизвлекаемые,
значение атрибута~\verb|CKA_EXTRACTABLE| должно быть~\verb|CK_FALSE| и
не может быть изменено.
\end{note}

\begin{note}
\doubt{Примечание}~---
\doubt{При генерации} ключей КТ, соответствующих СТБ 34.101.79,
уровень стойкости, неявно определяемый атрибутом \verb|CKA_ID| личного ключа,
должен соответствовать параметрам ЭК, указываемым в атрибуте 
\verb|CKA_EC_PARAMS| открытого ключа. \doubt{Значения атрибутов} 
\verb|CKA_SIGN| личного ключа и \verb|CKA_VERIFY| открытого ключа должны 
совпадать. \doubt{Значения атрибутов} \verb|CKA_UNWRAP| личного ключа и 
\verb|CKA_WRAP| открытого ключа должны совпадать. 
\end{note}

\doubt{Q: во-первых, о BTOK лучше говорить как можно меньше (лучше в BTOK 
сказать о настройке Cryptoki. По идентификатору определяется уровень? Но 
ведь на КТ мб несколько ключей одного уровня. Связь флагов спорная (или я 
чего-то не понимаю)} 

\doubt{A: Здесь имелось ввиду соответствие уровень-ссылка из btok: 128-1, 192-2, 256-3.
Связь флагов означает, что если лк можно использовать для выработки подписи,
то ок можно использовать для проверки, и наоборот. Аналогично для транспорта.
Если такого соответствия не будет, то получится странная ситуация - подпись есть,
но ее нельзя проверить, или есть токен, но его нельзя разобрать.}
\fi 

\section{Сертификаты}\label{OBJ.Certs}

При выпуске КТ в обращение на него обязательно записываются сертификат 
УЦ, отвечающего за управление инфраструктурой КТ и терминалов,
и собственно сертификат КТ. Сертификат КТ связан с личным ключом КТ. 

Сертификат КТ передается терминалу в процессе аутентификации. 
В ответ -- сертификат терминала. Чтобы уменьшить объем пересылаемых 
данных и упростить проверку сертификатов, они делаются облегченными.
Формат облегченных сертификатов определен в~\ref{CERTS}.

Дополнительно, при иcпользовании КТ на него могут быть записаны
сертификаты, которые соответствуют личным ключам eSign.
Формат этих сертификатов определен в СТБ 34.101.78.
Если сертификаты хранятся в КТ, то их рекомендуется размещать в файлах, 
определенных в приложении~\ref{FILES}.
%Для каждого личного ключа после его генерации в КТ может быть установлен 
%соответствующий ему сертификат. 
%Сертификаты должны соответствовать требованиям СТБ 34.101.19.

% todo: Нужен ли сертификат УЦ записывать?

Формат сертификатов и правила управления ими описаны в разделе~\ref{CERTS}.

\section{Объект \texttt{Name}}\label{OBJ.Name}

При формировании сертификата eSign готовится запрос, в который включаются 
специальным образом отформатированные идентификационные данные. Формат 
определяется типом \texttt{Name}, заданным в СТБ 34.101.19, 
с уточнениями, установленными в СТБ 34.101.78. Объект \texttt{Name}
может готовиться терминалом по прочитанным идентификационным данным.

Или объект может быть заранее сформирован и записан в КТ в процессе выпуска 
токена. В последнем случае объект рекомендуется хранить в файле,
описанном в приложении~\ref{FILES}.

\section{Прикладная программа eID}\label{OBJ.eID}

Прикладная программа eID обеспечивает управление атрибутами владельца КТ. 
Доступ к атрибутам осуществляется только после успешной аутентификации 
терминала. Атрибуты передаются по защищенному соединению в соответствии с 
разрешениями, установленными владельцем КТ, и правами, заданными в маршруте 
сертификации терминала (см.~\ref{CERTS.Path}).  

Прикладной программе eID назначается идентификатор \verb|id-eID|, 
определенный в приложении~\ref{ASN}. В приложении~\ref{FILES}
даны рекомендации по хранению объектов eID.

\section{Прикладная программа eSign}\label{OBJ.eSign}

Прикладная программа eSign обеспечивает генерацию личных и открытых 
ключей владельца КТ, управление сертификатами владельца, 
выработку подписи и разбор токена ключа.
%
Криптографические операции eSign основаны на алгоритмах СТБ 34.101.45.


\if 0
Прикладная программа eSign поддерживает одновременное 
использование нескольких личных ключей, 
которые могут применяться при выработке подписи и разборе токена ключа.
Личные ключи генерируются средствами КТ и никому не известны. 
К личному ключу можно обратиться только по идентификатору, 
он не может быть прочитан с КТ. 
Ключи, сгенерированные в локальном режиме, не могут использоваться 
в терминальном и наоборот.
\fi

Прикладной программе eSign назначается идентификатор \verb|id-eSign|, 
определенный в приложении~\ref{ASN}. В приложении~\ref{FILES}
даны рекомендации по хранению объектов eSign.


