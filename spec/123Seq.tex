\section{Последовательности операций}
\label{Oper.Seq}

\subsection{Аутентификация по паролю}
\label{Oper.Seq.BPACE}

Для аутентификации по паролю используется протокол BPACE (см.~\ref{CRYPTO.BPACE}). 
Для выполнения аутентифкации по паролю на стороне КТ должна 
использоваться следующая последовательность операций:

\begin{enumerate}
\item Выбрать мастер-файл (см.~\ref{Oper.Descr.SelectMF}), 
если он не является текущим выделенным файлом.

\item Инициализировать протокол BPACE (см.~\ref{Oper.Descr.SetBPACE}).

\item Выполнить шаги протокола BPACE (см.~\ref{Oper.Descr.GABPACE}).

\end{enumerate}

При аутентификации по паролю владелец КТ может
установить ограничения на доступ к данным и операциям КТ.
Данные ограничения задаются при инициализации 
протокола BPACE (см.~\ref{Oper.Descr.SetBPACE}).

При первом выполнении протокола BPACE обмен данными КП с КТ производится 
по незащищенному соединению. При успешном выполнении протокола между КТ и 
КП устанавливается защищенное соединение и КТ переходит в состояние PS
(см.~\ref{STATES.ST}). Новый сеанс протокола (если он 
предусмотрен) будет выполняться уже по защищенному соединению. 

Успешная аутентификация по паролю CAN возобновляет пароль PIN,  
если он был приостановлен (см.~\ref{OBJ.PIN}).

\subsection{Аутентификация терминала и КТ}
\label{Oper.Seq.BAUTH}

Аутентификация терминала и КТ производится по протоколу BAUTH 
(см.~\ref{CRYPTO.BAUTH}) после успешной аутентификации по паролю 
(см.~\ref{Oper.Seq.BPACE}). Аутентификация может быть односторонней 
(аутентификации терминала перед КТ) или взаимной (аутентификации терминала 
перед КТ и КТ перед терминалом). Для выполнения аутентифкации должна 
использоваться следующая последовательность операций:
%
\begin{enumerate}
\item Инициализировать протокол BAUTH (см.~\ref{Oper.Descr.SetBAUTH}).
\item Проверить сертификат терминала (см.~\ref{Oper.Descr.VerifyCert}).
\item Выполнить основные шаги протокола BAUTH (см.~\ref{Oper.Descr.GABAUTH}).
\end{enumerate}

Дополнительно, после успешного выполнения 
протокола BAUTH с взаимной аутентификацией сторон
срок действия КТ может быть получен с использованием
следующей последовательности операций:
%
\begin{enumerate}
\item Выбрать прикладную программу eID (см.~\ref{Oper.Descr.SelectApp}).
\item Получить срок действия КТ как дополнительный атрибут (см.~\ref{Oper.Descr.VerifyData}).
\end{enumerate}

%Аутентификация терминала и КТ может быть выполнена в \doubt{состоянии PS}.
При выполнении протокола BAUTH обмен данными терминала с КТ производится по 
защищенному соединению, установленному после выполнения протокола BPACE. 
При успешном выполнении протокола BAUTH между терминалом и КТ создается новое 
защищенное соединение, которое устанавливается в качестве текущего
соединения, при этом КТ переходит в состояние AS (см.~\ref{STATES.ST}).

\subsection{Активация пароля PIN}
\label{Oper.Seq.ActivatePIN}

Активация пароля PIN может потребоваться после его
принудительной деактивации (см.~\ref{Oper.Descr.DeactivatePIN}).

Для активации пароля PIN без использования терминала
должна использоваться следующая последовательность операций:
%
\begin{enumerate}
\item Выполнить аутентификацию по паролю PUK (см.~\ref{Oper.Seq.BPACE}).

\item Выбрать прикладную программу eSign (см.~\ref{Oper.Descr.SelectApp}).

\item Активировать пароль PIN (см.~\ref{Oper.Descr.ActivatePIN}).

\end{enumerate}

Для активации пароля PIN с использованием терминала
должна использоваться следующая последовательность операций:

\begin{enumerate}
\item Выполнить аутентификацию по паролю PUK (см.~\ref{Oper.Seq.BPACE}).

\item Выполнить аутентификацию терминала (см.~\ref{Oper.Seq.BAUTH}), 
в сертификате которого задано право управлять паролем PIN (см. \ref{DATA.Access}).

\item Выбрать прикладную программу  (см.~\ref{Oper.Descr.SelectApp}), 
для которой в сертификате авторизованного терминала установлено 
право управлять паролем PIN (см.~\ref{DATA.Access}).

\item Активировать пароль PIN (см.~\ref{Oper.Descr.ActivatePIN}).

\end{enumerate}

Активация пароля PIN не приводит к изменению состояния КТ.
После активации пароля PIN для получения доступа к
операциям, которые требуют предварительной
аутентфикации по данному паролю, необходимо выполнить аутентификацию 
по паролю PIN (см.~\ref{Oper.Seq.BPACE}) и, при необходимости, 
аутентификацию терминала и КТ (см.~\ref{Oper.Seq.BAUTH}).

\subsection{Управление паролем PIN}
\label{Oper.Seq.ControlPIN}

К операциям по управлению паролем PIN относятся:
\begin{itemize} 
\item[--] подтверждение (см.~\ref{Oper.Descr.VerifyPIN});
\item[--] изменение (см.~\ref{Oper.Descr.ChangePIN});
\item[--] разблокировка (см.~\ref{Oper.Descr.UnblockPIN}).
\end{itemize}

Для подтверждения или изменения пароля PIN предварительно 
должна быть выполнена аутентификация по 
паролю PIN, а для разблокировки пароля PIN~---
аутентификация по паролю PUK (см.~\ref{Oper.Seq.BPACE}).
Разблокировка может выполняться с изменением или без 
изменения пароля PIN (см.~\ref{Oper.Descr.UnblockPIN}).

После успешной аутентифкации по паролю,
при необходимости, может быть выполнена аутентификация 
терминала и КТ (см.~\ref{Oper.Seq.BAUTH}),
при этом в сертификате терминала должно быть задано право
управления паролем PIN (см.~\ref{DATA.Access}).

Изменение или разблокировка PIN может
производится прикладной программой eID или eSign,
а подтверждение пароля PIN~--- прикладной программой eSign.
Используемая для управления паролем PIN прикладная
программа дожна быть предварительно 
выбрана (см.~\ref{Oper.Descr.SelectApp}). 

В состоянии PS или AS:CP для управления паролем PIN
достаточно выполнить лишь соответствующую операцию.

В состоянии AS:AT для управления паролем PIN может
использоваться следующая последовательность операций:
%
\begin{enumerate} 
\item Переключиться на соединение,
      установленное между КТ и КП (см.~\ref{Oper.Descr.SetCS}).
\item Выбрать прикладную программу (см.~\ref{Oper.Descr.SelectApp}),
      для которой в сертификате авторизованного терминала задано 
      соответствующее право по управлению паролем PIN (см. \ref{DATA.Access}).
\item Выполнить требуемую операцию по управлению паролем PIN.
\item Переключиться на соединение, установленное между КТ 
      и терминалом (см.~\ref{Oper.Descr.SetCS}).
\item При необходимости, выбрать нужную прикладную программу 
(см.~\ref{Oper.Descr.SelectApp}).
\end{enumerate}


\subsection{Генерация ключевой пары и установка сертификата}
\label{Oper.Seq.GeKeySetCert}

Для генерации ключевой пары и 
установки сертификата предварительно 
должна быть выполнена аутентификация по 
паролю PIN (см.~\ref{Oper.Seq.BPACE}).

После успешной аутентифкации по паролю,
при необходимости, может быть выполнена взаимная 
аутентификация терминала и КТ (см.~\ref{Oper.Seq.BAUTH}),
при этом в сертификате терминала должно быть задано
право генерации ключей (см.~\ref{DATA.Access}).

Генерация ключевой пары и установка сертификата производится 
прикладной программой eSign, которая дожна быть предварительно 
выбрана (см.~\ref{Oper.Descr.SelectApp}). 

В состояних PS и AS может быть сгенерировано
до трех ключевых пар (см.~\ref{Oper.Descr.GenKeys}), 
соответствующих различным уровням стойкости. 
Сгенерированные личные ключи могут использоваться
для подписи данных (см.~\ref{Oper.Seq.Sig}) и разбора токена 
ключа (см.~\ref{Oper.Seq.Decipher}).
При этом личный ключ, сгенерированный в одном из состояний, 
не может использоваться в другом состоянии. 

Открытый ключ, который возвращается при генерации ключевой пары
(см.~\ref{Oper.Descr.GenKeys}), должен использоваться при формировании 
запроса на выпуск сертификата.
При формировании запроса дополнительно могут использоваться данные eSign, 
специально для этого предназначенные и предварительно
установленные в КТ.
Указанные данные могут быть установлены (см.~\ref{Oper.Descr.Update}) 
авторизованным терминалом, в сертификате которого указано право устанавливать данные 
для запроса на выпуск сертификата (см.~\ref{DATA.Access}), 
при выполнении операции обновления данных  
и получены авторизованным терминалом, в сертификате которого задано право на установку 
сертификата (см.~\ref{DATA.Access}),
при выполнении операции чтения данных (см.~\ref{Oper.Descr.Read}).

Запрос на выпуск сертификата должен быть подписан (см.~\ref{Oper.Seq.Sig})
личным ключом, соответствующим открытому ключу из запроса.

После формирования сертификат может быть установлен в КТ.
Для установки сертификата должна использоваться операция 
обновления данных (см.~\ref{Oper.Descr.Update}). 
В состоянии AS установка сертификата должна выполняться 
авторизованным терминалом, в сертификате которого задано право на 
запись сертификата (см.~\ref{DATA.Access}). 

\doubt{В случае, если формирование запроса и запись сертификата
выполняются в разных сеансах, то 
после формирование запроса и до записи сертификата 
рекомендуется записывать вместо сертификата 
хэш-значение, вычисленное
алгоритмом \texttt{belt-hash} от закодированного значения 
подписанного запроса на выпуск сертификата.
Данное значение может быть использовано для получения от УЦ
сертификата после его выпуска (см. СТБ~34.101.78).
}

Сертификаты и данные, предназначенные для формирования запроса
на выпуск сертификатов, хранятся на КТ в определенных элементарных файлах, 
описанных в таблице~\ref{Table.FILES.EFSIGN}.
Данные для запроса на выпуск сертификата 
хранятся в элементарном файле в виде закодированного
значения типа Name, определенного в СТБ 34.101.19.

\subsection{Выработка подписи}
\label{Oper.Seq.Sig}

Для выработки подписи предварительно 
должна быть выполнена аутентификация по 
паролю PIN  (см.~\ref{Oper.Seq.BPACE}).

После успешной аутентифкации по паролю,
при необходимости, может быть выполнена 
аутентификация терминала и КТ (см.~\ref{Oper.Seq.BAUTH});
при этом, в сертификате терминала должно быть задано право
выработки подписи (см.~\ref{DATA.Access}).

Выработка подписи производится прикладной программой eSign, которая
должна быть предварительно выбрана (см.~\ref{Oper.Descr.SelectApp}).

Для выработке подписи  должна использоваться 
следующая последовательность операций:
%
\begin{enumerate}
\item Если статус подтверждения пароля PIN не установлен,
      подтвердить пароль PIN (см.~\ref{Oper.Seq.ControlPIN}).
\item Инициализировать алгоритм выработки подписи (см.~\ref{Oper.Descr.SetDST}).
\item Выработать подпись (см.~\ref{Oper.Descr.Signature}).
\end{enumerate}
%
Указанные последовательности операций должны выполняться
при каждой выработке подписи.

Для проверки статуса подтверждения пароля PIN может использоваться 
соответствующая операция (см.~\ref{Oper.Descr.VerifyAuth}).

\subsection{Разбор токена ключа}
\label{Oper.Seq.Decipher}

Для разбора токена ключа предварительно 
должна быть выполнена аутентификация по 
паролю PIN  (см.~\ref{Oper.Seq.BPACE}).

После успешной аутентифкации по паролю,
при необходимости, может быть выполнена аутентификация 
терминала и КТ (см.~\ref{Oper.Seq.BAUTH}),
при этом в сертификате терминала должно быть задано право
разбора токена ключа (см.~\ref{DATA.Access}).

Разбор токена ключа производится прикладной программой eSign, которая
должна быть предварительно выбрана (см.~\ref{Oper.Descr.SelectApp}).

Для разбора токена ключа должна использоваться 
следующая последовательность операций:
%
\begin{enumerate}
%\item Если состояние аутентификации по PIN сброшено,
%      подтвердить пароль PIN (см.~\ref{Oper.Seq.ControlPIN}).
\item Инициализировать алгоритм разбора токена ключа (см.~\ref{Oper.Descr.SetCT}).
\item Разобрать токен ключа (см.~\ref{Oper.Descr.Decipher}).
\end{enumerate}
%
Указанная последовательность операций должна выполняться
при каждом разборе токена ключа.
