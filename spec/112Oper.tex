\clearpage

\section{Описание операций}\label{Oper.Descr}

\subsection{Активация личного ключа}\label{Oper.Descr.ActivateKey}

Для активации личного ключа используется команда <Activate>,
которая определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\
\hline
\hline
INS & $\hex{44}$: активировать\\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{2100}$: 
активировать ключ, определяемый CDF\\
\hline
CDF &  $\der(\hex{84}, X)$,   
где $X$ определяет ссылку на личный ключ 
(см. табл.~\ref{Table.Oper.KeyRef}) \\ 
%В состоянии PS может принимать 
%значение 1 для ключа уровня стойкости $l=128$, 
%значение 2 для ключа уровня стойкости $l=192$, 
%значение 3 для ключа уровня стойкости $l=256$.
%В состоянии AS может принимать 
%значение 4 для ключа уровня стойкости $l=128$, 
%значение 5 для ключа уровня стойкости $l=192$, 
%значение 6 для ключа уровня стойкости $l=256$. \\
\hline \hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$ (успешное выполнение): ключ активирован\\
 & $\hex{6982}$ (не соответствует состоянию безопасности): 
для текущего состояния КТ ключ не может быть активирован, 
или терминал не авторизован для активации ключа\\
 & другое (системная ошибка): изменение состояния PIN завершено 
неудачно\\
\hline
\end{tabular}

При генерации личного ключа (см. \ref{Oper.Descr.GenKeys})
он автоматически активируется, 
и в вызове команды <Activate> нет явной необходимости. 
Вызов команды может потребоваться после 
принудительной деактивации ключа (см.~\ref{Oper.Descr.DeactivateKey}).  

Если ключ уже активирован, то должен быть 
возвращен статус $\text{SW1} \parallel \text{SW2} = \hex{9000}$.

Команда может быть вызвана для приложения eSign в состояниях PS, AS:AT.
В состоянии AS:AT команда может быть вызвана только
авторизованным терминалом, в сертификате которого задано право
активировать ключи (см. \ref{DATA.Access}).

Команда требует предварительной аутентификации 
по протоколу BPACE c паролем PIN.

% todo: Может стоит указывать ссылку на одну из таблиц 
% \ref{Table.DATA.Access} или \ref{Table.DATA.SMTAccess}, а не на раздел 
% целиком? 
%
% todo: Не сказано четко, когда взаимная аутентификация по BAUTH.

\subsection{Активация PIN}\label{Oper.Descr.ActivatePIN}

Для активации PIN (см.~\ref{OBJ.PIN})  используется
команда <Activate>, которая определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\
\hline
\hline
INS & $\hex{44}$: активировать\\
\hline
P1 & $\hex{10}$: активировать пароль, определяемый P2\\
\hline
P2 & $\hex{03}$: PIN \\
\hline
CDF &  --- \\
\hline \hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$ (успешное выполнение): PIN активирован\\
 & $\hex{6982}$ (не соответствует состоянию безопасности): ТA не 
авторизован для изменения состояния PIN\\
 & другое (системная ошибка): изменение состояния PIN завершено 
неудачно\\
\hline
\end{tabular}

Первоначально PIN является активированным, и в вызове команды <Activate> 
нет явной необходимости. Вызов команды может потребоваться после 
принудительной деактивации PIN (см.~\ref{Oper.Descr.DeactivatePIN}). 

Если PIN уже активирован, то должен быть возвращен 
статус $\text{SW1} \parallel \text{SW2} = \hex{9000}$.

Команда может быть вызвана для приложения eSign 
в состояниях PS, AS:AT и для приложения eID в состоянии AS:AT. 
В состоянии AS:AT команда может быть вызвана 
только авторизованным терминалом, в сертификате которого задано право
управлять паролем PIN (см. \ref{DATA.Access}).

Команда требует предварительной аутентификации по 
протоколу BPACE c паролем PUK.

\subsection{Выбор мастер-файла}
\label{Oper.Descr.SelectMF}

Для выбора мастер-файла (см.~\ref{FILES}) 
используется команда <Select File>, 
которая определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{A4}$: выбрать файл\\ 
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{0000}$: выбор мастер-файла\\
\hline
CDF & --- \\
\hline \hline
RDF &  --- \\
\hline
$\text{SW1}\parallel\text{SW2}$ & 
$\hex{9000}$ (успешное выполнение): мастер-файл выбран успешно\\
 & другое (системная ошибка): ошибка выбора мастер-файла\\
\hline
\end{tabular}

Первоначально выделенный файл (см.~\ref{FILES}), 
соответствующий мастер-файлу, является текущим.
и в вызове команды <Select File> нет явной необходимости. 
Вызов команды может потребоваться после 
выбора приложения (см.~\ref{Oper.Descr.SelectApp})
или выбора элементарного файла (см.~\ref{Oper.Descr.SelectEF}). 

Если мастер-файл уже выбран, то должен быть возвращен 
статус $\text{SW1} \parallel \text{SW2} = \hex{9000}$.

Команда может быть вызвана в любом из состояний на 
любом уровне.

После успешного выполнения команды выделенный файл (см.~\ref{FILES}), 
соответствующий мастер-файлу, становится текущим.

\subsection{Выбор прикладной программы}
\label{Oper.Descr.SelectApp}

Для выбора прикладной программы используется 
команда <Select File>, 
которая определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{A4}$: выбрать файл\\ 
\hline
P1 & $\hex{04}$: выбор прикладной программы\\
\hline
P2 & $\hex{0C}$: возврат информации о файле не требуется \\
\hline
CDF & AID прикладной программы (см. приложение~\ref{FILES})\\
\hline \hline
RDF &  --- \\
\hline
$\text{SW1}\parallel\text{SW2}$ & 
$\hex{9000}$ (успешное выполнение): файл выбран успешно\\
 & $\hex{6A82}$: файл не найден\\
 & $\hex{6A86}$: некорректные параметры $\text{P1} \parallel \text{P2}$ \\
 & другое (системная ошибка): ошибка выбора файла\\
\hline
\end{tabular}

Команда может быть вызвана в состояниях PS и AS
на любом уровне.

Для выбора приложения eSign команда требует 
предварительной аутентификации по протоколу 
BPACE c паролем PIN или PUK.

Для выбора приложения eID команда требует 
предварительной аутентификации по протоколу BPACE c 
паролем CAN, PIN или PUK.

Если прикладная программа уже выбрана, то должен быть возвращен
статус $\text{SW1} \parallel \text{SW2} = \hex{9000}$.

После успешного выполнения команды выделенный файл (см.~\ref{FILES}), 
соответствующий выбранной прикладной программе, становится текущим.

\subsection{Выбор элементарного файла}
\label{Oper.Descr.SelectEF}

Для выбора элементарного файла используется 
команда <Select File>, 
которая определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{A4}$: выбрать файл\\ 
\hline
P1 & $\hex{02}$: выбор элементарного файла для текущей прикладной программы\\
\hline
P2 & $\hex{0C}$: возврат информации о файле не требуется \\
\hline
CDF & FID элементарного файла в текущей прикладной программе (см. приложение~\ref{FILES})\\
\hline \hline
RDF &  --- \\
\hline
$\text{SW1}\parallel\text{SW2}$ & 
$\hex{9000}$ (успешное выполнение): файл выбран успешно\\
 & $\hex{6A82}$: файл не найден\\
 & $\hex{6A86}$: некорректные параметры $\text{P1} \parallel \text{P2}$ \\
 & другое (системная ошибка): ошибка выбора файла\\
\hline
\end{tabular}

Команда может вызываться в состояниях PS, AS:AT 
для прикладной программы eSign и в состоянии 
AS:AT для прикладной программы eID.
В состоянии AS:AT команда может вызываться только 
авторизованным терминалом, в сертификате которого
задано право доступа к соответствующему элементарному файлу (см. \ref{DATA.Access}).

Для выбора элементарных файлов приложения eSign команда требует 
предварительной аутентификации по протоколу BPACE c 
паролем PIN.

Для выбора элементарных файлов приложения eID команда требует 
предварительной аутентификации по протоколу BPACE c 
паролем CAN или PIN.

Для выбора элементарных файлов в состоянии AS:AT
команда требует взаимной аутентификации КТ и терминала
по протоколу BAUTH (см.~\ref{Oper.Descr.SetBAUTH}).

Элементарные файлы, которые могут быть выбраны 
для приложений eSign и eID, приводятся в приложении~\ref{FILES}. 

После успешного выполнения команды выбранный элементарный файл
(см.~\ref{FILES}) становится текущим.
Выбор элементарного файла может потребоваться для
чтения (см.~\ref{Oper.Descr.Read}) или 
обновления (см.~\ref{Oper.Descr.Update}) данных.

\subsection{Выполнение основных шагов протокола BAUTH}
\label{Oper.Descr.GABAUTH} 

Для выполнения основных шагов протокола BAUTH 
используется команда <General Authenticate>, 
которая определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & 	Описание \\
\hline
\hline
INS & $\hex{86}$: общая аутентификация \\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{0000}$: протокол уже задан\\ 
\hline
CDF & отсутствует или $\der(\hex{7C}, X)$, 
где~$X$~--- сообщение протокола, сформированное терминалом
(см. табл.~\ref{Table.Oper.BAUTH})\\
\hline \hline
RDF & $\der(\hex{7C}, X)$, где~$X$~--- 
сообщение протокола, сформированное КТ 
(см. табл.~\ref{Table.Oper.BAUTH})\\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$ 
(успешное выполнение): протокол (шаг) выполнен успешно\\
 & $\hex{6300}$ (ошибка аутентификации): протокол (шаг) выполнен с ошибкой \\
 & $\hex{6982}$ (не соответствует состоянию безопасности): протокол не может 
быть выполнен для текущего состояния КТ\\
 & $\hex{6A80}$ (некорректные данные в RDF): предоставленные данные некорректны\\
 & другое (системная ошибка): протокол (шаг) выполнен с ошибкой \\
\hline
\end{tabular}

Для выполнения основных шагов протокола BAUTH
должна вызываться цепочка команд <General 
Authenticate> с входными и выходными данными из таблицы~\ref{Table.Oper.BAUTH}, 
которые определяются в соответствии с~\ref{CRYPTO.BAUTH}. 
При односторонней аутентификации компонент RDF в ответе на вторую команду
в цепочке не возвращается.

\begin{table}[h]
\caption{Данные цепочки команд, реализующих протокол BAUTH}
\label{Table.Oper.BAUTH}
\begin{tabular}{|c|c|c|}
\hline
№ вызова & Данные в команде & Данные в ответе\\
\hline
\hline
1 & --- & $\der(\hex{80}, \text{M1})$\\
\hline
2 & $\der(\hex{81}, \text{M2})$ & 
$\der(\hex{82}, \text{M3})$  \\
\hline
\end{tabular}
\end{table}

Команда может вызываться на уровне мастер-файла в состоянии PS 
непосредственно после проверки сертификата терминала
(см. \ref{Oper.Descr.VerifyCert}).

После успешного выполнения протокола BAUTH между КТ и терминалом 
устанавливается защищенное соединение (см.~\ref{CMDS.SM}).

\subsection{Выполнение шагов протокола BPACE}
\label{Oper.Descr.GABPACE} 

Для выполнения шагов протокола BPACE 
используется команда <General Authenticate>,
которая определяется следующим образом: 


\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & 	Описание \\
\hline
\hline
INS & $\hex{86}$: общая аутентификация \\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{0000}$: протокол уже задан\\ 
\hline
CDF & $\der(\hex{7C}, X)$, 
где~$X$~--- сообщение протокола, сформированное КП (см. табл.~\ref{Table.Oper.BPACE})\\
\hline \hline
RDF & $\der(\hex{7C}, X)$, где~$X$~--- 
сообщение протокола, сформированное КТ (см. табл.~\ref{Table.Oper.BPACE})\\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$ 
(успешное выполнение): протокол (шаг) выполнен успешно\\
 & $\hex{6300}$ (ошибка аутентификации): протокол (шаг) выполнен с ошибкой \\
 & $\hex{63CX}$ (ошибка аутентификации): протокол (шаг) выполнен с ошибкой, 
значение \texttt{X} содержит количество оставшихся попыток аутентификации 
(при $\texttt{X} = 1$ пароль приостановлен, а при $\texttt{X} = 0$~--- 
заблокирован)\\ 
 & $\hex{6982}$ (не соответствует состоянию безопасности): протокол не может 
быть выполнен для текущего состояния КТ\\
% & $\hex{6983}$ (аутентификация заблокирована): пароль заблокирован \\
 & $\hex{6984}$ (необходимые данные не доступны): пароль деактивирован \\
% & $\hex{6985}$ (не соответствует условиям использования): пароль приостановлен\\
 & $\hex{6A80}$ (некорректные данные в RDF): предоставленные данные некорректны\\
 & другое (системная ошибка): протокол (шаг) выполнен с ошибкой \\
\hline
\end{tabular}

Для выполнения шагов протокола BPACE должна вызываться цепочка 
команд <General Authenticate> с входными и выходными данными 
из таблицы~\ref{Table.Oper.BPACE}, 
которые определяются в соответствии с~\ref{CRYPTO.BPACE}. 

\begin{table}[h]
\caption{Данные цепочки команд, реализующих протокол BPACE}
\label{Table.Oper.BPACE}
\begin{tabular}{|c|c|c|}
\hline
№ вызова & Данные в команде & Данные в ответе\\
\hline
\hline
 & <General Authenticate> &  \\
\hline
\hline
1 & $\der(\hex{80}, \text{M1})$ & 
$\der(\hex{81}, \text{M2})$\\
\hline
2 & $\der(\hex{82}, \text{M3})$ & 
$\der(\hex{83}, \text{M4})$\\
\hline
\end{tabular}
\end{table}

Команда может вызываться на уровне мастер-файла в любом состоянии
непосредственно после инициализации протокола 
BPACE (см. \ref{Oper.Descr.SetBPACE}).

Успешное выполнение протокола BPACE с использованием пароля PIN 
устанавливает статус подтверждения пароля PIN.
В свою очередь, неуспешное выполнение протокола BPACE с использованием 
пароля PIN сбрасывает статус подтверждения пароля PIN, 
если он был установлен ранее.

После успешного выполнения протокола BPACE между КТ и КП 
устанавливается защищенное соединение (см.~\ref{CMDS.SM}).

\subsection{Выработка подписи}
\label{Oper.Descr.Signature}

Для выработки подписи используется 
команда <PSO: Compute Digital Signature>
(аббр. от <<Perform Security Operation: Compute Digital Signature>>),
которая определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\ 
\hline
\hline
INS & $\hex{2A}$: управление средой безопасности \\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{9E9A}$: выработать
электронную подпись \\ 
\hline
CDF & Хэш-значение, вычисленное от данных\\
\hline \hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$ 
(успешное выполнение): подпись успешно выработана \\
 & $\hex{6982}$ (не соответствует состоянию безопасности): терминал не 
авторизован для выработки подписи\\
 & $\hex{6984}$ (необходимые данные не доступны): ключ уже существует\\
 & $\hex{6A80}$ (некорректные данные): некорректная длина
хэш-значения \\
 & другое (системная ошибка): открытый ключ не может быть импортирован\\
\hline
\end{tabular}

В компоненте CDF команды должно передаваться хэш-значение, которое вычислено
от подписываемых данных алгоритмом хэширования, указанным 
при инициализации алгоритма подписи, и длина которого соответствует
уровню стойкости личного ключа, выбранного при инициализации алгоритма подписи.

При выработке подписи используется алгоритм \texttt{bign-sign}
(см.~\ref{CRYPTO.StdAlg}) со стандартными параметрами, 
которые определяются неявно по личному ключу.  

%Команда требует предварительной аутентификации по 
%протоколу BPACE c паролем PIN. 

Команда может вызываться для приложения eSign в состояниях 
PS и AS:AT непосредственно после инициализации алгоритма подписи
(см. \ref{Oper.Descr.SetDST}).
%В состоянии AS:AT команда может вызываться только авторизованным 
%терминалом с правом выработки подписи (см. \ref{DATA.Access}).

Выполнение команды приводит к сбрасыванию статуса подтверждения пароля PIN
после успешного или неуспешного выполнения $N$ команд, где $N$ --- значение, 
задаваемое при инициализации протокола BPACE (см. \ref{Oper.Descr.SetBPACE}).
Для установки статуса подтверждения пароля PIN 
необходимо либо подтвердить пароль PIN (см.~\ref{Oper.Descr.VerifyPIN}), 
либо повторно выполнить аутентификацию по паролю PIN (см.~\ref{Oper.Seq.BPACE}).

\subsection{Генерация ключевой пары}\label{Oper.Descr.GenKeys}

Для генерации ключевой пары (личного и открытого ключа) прикладной программы eSign
используется команда <Generate Asymmetric Key Pair>. При выполнении команды 
сгенерированный личный ключ сохраняется в КТ,
а открытый ключ возвращается как данные ответа.
После генерации личный ключ может использоваться 
для выработки подписи (см. \ref{Oper.Descr.Signature}) и
разбора токена ключа (см. \ref{Oper.Descr.Decipher}).
Команда определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\
\hline
\hline
INS & $\hex{47}$: сгенерировать ключевую пару \\
\hline
$\text{P1} \parallel\text{P2}$ & $\hex{8200}$:
вернуть открытый ключ \\
\hline
CDF & $\der(\hex{B6},\der(\hex{84}, X))$,
где $X$ определяет ссылку на генерируемый личный ключ
(см. табл.~\ref{Table.Oper.KeyRef}) \\
%В состоянии PS может принимать 
%значение 1 для ключа уровня стойкости $l=128$, 
%значение 2 для ключа уровня стойкости $l=192$, 
%значение 3 для ключа уровня стойкости $l=256$.
%В состоянии AS может принимать 
%значение 4 для ключа уровня стойкости $l=128$, 
%значение 5 для ключа уровня стойкости $l=192$, 
%значение 6 для ключа уровня стойкости $l=256$. \\
\hline \hline
RDF & $\der(\hex{7F49}, Y)$, где $Y$ является открытым ключом длины $4l$ бит\\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$ (успешное выполнение): ключевая пара сгенерирована\\
 & $\hex{6982}$ (не соответствует состоянию безопасности): терминал не 
авторизован для генерации ключевой пары\\
 & $\hex{6984}$ (необходимые данные не доступны): ключ уже существует\\
 & $\hex{6A88}$ (необходимые данные не найдены): неверная ссылка на ключ\\
 & другое (системная ошибка): генерация ключевой пары выполнена неудачно\\
\hline
\end{tabular}

Допустимые значения ссылок на личный ключ определяются
в соответствии с табл.~\ref{Table.Oper.KeyRef} и зависят от
уровня стойкости личного ключа и состояния КТ.
КТ должен поддерживать генерацию ключей уровня стойкости 
$l=128$ и может поддерживать генерацию ключей 
уровней стойкости $l=192, 256$.

\begin{table}[hbt]
\caption{Допустимые значения ссылок на личный ключ}
\label{Table.Oper.KeyRef}
\begin{tabular}{|c|c|c|c|}
\hline
Уровень стойкости & \multicolumn{2}{|c|}{Значение ссылки} & Поддержка\\
\cline{2-3}
ключа & Состояние PS & Состояние AS & \\
\hline
\hline
128 & $\hex{01}$ & $\hex{11}$ & Обязательна \\
192 & $\hex{02}$ & $\hex{12}$ & Необязательна\\
256 & $\hex{03}$ & $\hex{13}$ & Необязательна\\
\hline
\end{tabular}
\end{table}

При генерации ключей используется алгоритм \texttt{bign-sign}
со стандартными параметрами, которые определяются неявно
по ссылке на личный ключ. 

Команда может вызываться для приложения eSign в состояниях 
PS и AS:AT. В состоянии AS:AT команда может вызываться 
только авторизованным терминалом, в сертификате которого задано право
генерации ключей в терминальном режиме (см. \ref{DATA.Access}).

Команда требует предварительной аутентификации по 
протоколу BPACE c паролем PIN. При вызове
команды статус подтверждения пароля PIN должен быть 
установлен.

Выполнение команды приводит к сбрасыванию статуса подтверждения пароля PIN.
Для установки статуса подтверждения пароля PIN 
необходимо либо подтвердить пароль PIN (см.~\ref{Oper.Descr.VerifyPIN}), 
либо повторно выполнить аутентификацию по паролю PIN (см.~\ref{Oper.Seq.BPACE}).

Если при выполнении команды личный ключ с указанной в команде ссылкой 
уже существует, то должен быть возвращен статус 
$\text{SW1} \parallel \text{SW2} = \hex{6984}$. 
При этом для генерации нового ключа старый ключ должен быть предварительно 
уничтожен командой <Terminate> (см.~\ref{Oper.Descr.Terminate}).

\subsection{Деактивация личного ключа}
\label{Oper.Descr.DeactivateKey} 

Для деактивации личного ключа 
используется команда <Deactivate>,
которая определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\
\hline
\hline
INS & $\hex{04}$: деактивировать\\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{2100}$: 
деактивировать ключ, определяемый полем данных\\
\hline
CDF &  $\der(\hex{84}, X)$,   
где $X$ определяет ссылку на личный ключ 
(см. табл.~\ref{Table.Oper.KeyRef})\\
%В состоянии PS может принимать 
%значение 1 для ключа уровня стойкости $l=128$, 
%значение 2 для ключа уровня стойкости $l=192$, 
%значение 3 для ключа уровня стойкости $l=256$.
%В состоянии AS может принимать 
%значение 4 для ключа уровня стойкости $l=128$, 
%значение 5 для ключа уровня стойкости $l=192$, 
%значение 6 для ключа уровня стойкости $l=256$. \\
\hline \hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$ (успешное выполнение): ключ деактивирован\\
 & $\hex{6982}$ (не соответствует состоянию безопасности): 
для текущего состояния КТ ключ не может быть деактивирован, 
или терминал не авторизован для деактивации ключа\\
 & другое (системная ошибка): изменение состояния PIN завершено 
неудачно\\
\hline
\end{tabular}

Команда может вызываться для приложения eSign в состояниях 
PS и AS:AT. В состоянии AS:AT команда может вызываться 
только авторизованным терминалом, в сертификате которого задано право
деактивировать ключи (см. \ref{DATA.Access}).

Команда требует предварительной аутентификации по 
протоколу BPACE c паролем PIN. 

Если ключ уже деактивирован, то должен быть возвращен статус
$\text{SW1} \parallel \text{SW2} = \hex{9000}$.

После деактивации личного ключа выполнение любых операций, 
требующих его использования, становится невозможным.

\subsection{Деактивация PIN}
\label{Oper.Descr.DeactivatePIN} 

Для деактивации PIN (см.~\ref{OBJ.PIN}) 
используется команда <Deactivate>, 
которая определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{04}$: деактивировать \\
\hline
P1 & $\hex{10}$: деактивировать пароль, определяемый P2\\
\hline
P2 & $\hex{03}$: PIN \\
\hline
CDF &  --- \\
\hline \hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$ 
(успешное выполнение): PIN был деактивирован\\ 
 & $\hex{6982}$ (не соответствует состоянию безопасности): 
нет прав для выполнения операции\\
 & другое (системная ошибка): изменение состояния PIN завершено неудачно\\
\hline
\end{tabular}

Команда может вызываться для приложения eSign в состояниях 
PS, AS:AT и для приложения eID в состоянии AS:AT. 
В состоянии AS:AT команда может вызываться 
только авторизованным терминалом,
в сертификате которого задано право 
управлять паролем PIN или право деактивировать 
пароль PIN (см. \ref{DATA.Access}).

Команда требует предварительной аутентификации по 
протоколу BPACE c паролем PIN или PUK. 

Если PIN уже деактивирован команда, то должен быть возвращен 
статус $\text{SW1} \parallel \text{SW2} = \hex{9000}$.

После деактивации PIN выполнение любых операций, 
требующих аутентификации по паролю PIN (см. табл.~\ref{Table.Oper.List}), 
становится невозможным. 
При этом КТ переходит в состояние IS и мастер-файл 
становится текущим выделенным файлом. 


\subsection{Изменение PIN}
\label{Oper.Descr.ChangePIN}

Для изменения PIN используется команда <Change reference data>,
которая определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & 	Описание \\
\hline
\hline
INS & $\hex{24}$: изменить данные\\
\hline
P1 & $\hex{00}$: задавать старое и новое значение пароля \\
   & $\hex{01}$: задавать только новое значение пароля\\
\hline
P2 & $\hex{03}$: значение PIN \\
\hline
CDF & при $\hex{00}$ старое и новое значение PIN в формате UTF8\\
    & при $\hex{01}$ новое значение PIN в формате UTF8\\
\hline \hline
RDF & 	 --- \\
\hline
$\text{SW1}\parallel\text{SW2}$ & $\hex{9000}$ (успешное выполнение): 
изменение PIN было выполнено успешно\\
 & $\hex{6982}$ (не соответствует состоянию безопасности): нет прав для 
выполнения операции\\
 & другое (системная ошибка): изменение PIN завершено неудачно\\
\hline
\end{tabular}

Команда может вызываться для приложения eSign в состояниях 
PS, AS:AT и для приложения eID в состоянии AS:AT. 
В состоянии AS:AT команда может вызываться 
только авторизованным терминалом,
в сертификате которого задано право 
управлять паролем PIN или право изменять пароль 
PIN (см. \ref{DATA.Access}).

Команда требует предварительной аутентификации по 
протоколу BPACE c паролем PIN. 

Выполнение команды приводит к сбрасыванию 
статуса подтверждения пароля PIN.
Для установки статуса подтверждения пароля PIN 
необходимо либо подтвердить пароль PIN (см.~\ref{Oper.Descr.VerifyPIN}), 
либо повторно выполнить аутентификацию по паролю PIN (см.~\ref{Oper.Seq.BPACE}).


\subsection{Инициализация алгоритма выработки подписи}
\label{Oper.Descr.SetDST}
Для инициализации алгоритма подписи используется команда     
<MSE: Set DST> (аббревиатура от <<Manage Security Environment: Set 
Digital Signature Template>).
Команда задает личный ключ и алгоритм
хэширования, которые будут использоваться при выработке подписи.
Команда определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{22}$: управление средой безопасности\\ 
\hline
$\text{P1} \parallel\text{P2}$ & $\hex{41B6}$: 
выбрать для алгоритма выработки подписи \\
\hline
CDF & 
$\der(\hex{84}, X) \parallel \der(\hex{80}, Y)$, 
где $X$ определяет ссылку на личный ключ (см. табл. \ref{Table.Oper.KeyRef}), 
а $Y$ определяет идентификатор используемого при выработке
подписи алгоритма хэширования и
принимает значение $\hex{90}$ для алгоритма хэширования \texttt{hbelt},  
$\hex{B0}$ для алгоритма хэширования \texttt{bash384} и 
$\hex{C0}$ для алгоритма хэширования \texttt{bash512}\\
\hline \hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$ (успешное выполнение): ключ и алгоритм хэширования
выбраны \\
 & $\hex{6982}$ (не соответствует состоянию безопасности): 
для текущего состояния КТ ключ не может быть выбран или
терминал не авторизован для разбора токена ключа\\
 & $\hex{6283}$ (ссылаемые данные деактивированы): личный ключ деактивирован\\
 & $\hex{6984}$ (ссылаемые данные не доступны): личный ключ уничтожен\\
 & $\hex{6A88}$ (ссылаемые данные не найдены): личный ключ не существует\\
 & $\hex{6A80}$ (некорректные данные в CDF): алгоритм хэширования
не поддерживается или не соответствуеет уровню стойкости ключа \\
 & другое (системная ошибка): выбор личного ключа и алгоритма
хэширования завершился с ошибкой  \\
\hline
\end{tabular}

В компоненте CDF алгоритм хэширования \texttt{belt-hash}
может быть задан только совместно с личным ключом 
уровня стойкости $l=128$,
а алгоритмы хэширования \texttt{bash384} и \texttt{bash384}~--- 
с личными ключами уровней стойкости $l=192$ или $l=256$
соответственно.
%Уровень стойкости алгоритма хэширования \texttt{bash} определяется 
%неявно по уровню стойкости выбранного личного ключа.

Команда требует предварительной аутентификации по 
протоколу BPACE c паролем PIN. 
При вызове команды статус подтверждения 
пароля PIN должен быть установлен.
Для установки статуса подтверждения пароля PIN 
необходимо либо подтвердить пароль PIN (см.~\ref{Oper.Descr.VerifyPIN}), 
либо повторно выполнить аутентификацию по паролю PIN (см.~\ref{Oper.Seq.BPACE}).

Команда может вызываться для приложения eSign в 
состояниях PS и AS:AT. В состоянии AS:AT команда 
может вызываться только авторизованным терминалом,
в сертификате которого задано право 
выработки подписи в терминальном режиме 
(см. \ref{DATA.Access}).


\subsection{Инициализация алгоритма разбора токена ключа}
\label{Oper.Descr.SetCT}

Для инициализации алгоритма разбора токена ключа
используется команда <MSE: Set CT> (аббревиатура от <<Manage Security Environment: Set 
Confidentialy template>).
Команда задает личный ключ, 
который будет использоваться при разборе токена подписи.
Команда определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{22}$: управление средой безопасности\\ 
\hline
$\text{P1} \parallel\text{P2}$ & $\hex{41B8}$: 
выбрать для алгоритма разбора токена ключа
(расшифрования ключа) \\
\hline
CDF & 
$\der(\hex{84}, X)$, 
где $X$ определяет ссылку на личный ключ
(см. табл. \ref{Table.Oper.KeyRef})\\
%В состоянии PS ссылка $X$ должна принимать 
%значение 1 для ключа уровня стойкости $l=128$, 
%значение 2 для ключа уровня стойкости $l=192$, 
%значение 3 для ключа уровня стойкости $l=256$.
%В состоянии AS ссылка $X$ должна принимать 
%значение 4 для ключа уровня стойкости $l=128$, 
%значение 5 для ключа уровня стойкости $l=192$, 
%значение 6 для ключа уровня стойкости $l=256$. \\
\hline \hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$ (успешное выполнение): ключ выбран \\
 & $\hex{6982}$ (не соответствует состоянию безопасности): 
для текущего состояния КТ ключ не может быть выбран или
терминал не авторизован для разбора токена ключа\\
 & $\hex{6283}$ (ссылаемые данные деактивированы): личный ключ деактивирован\\
 & $\hex{6984}$ (ссылаемые данные не доступны): личный ключ уничтожен\\
 & $\hex{6A88}$ (ссылаемые данные не найдены): личный ключ не существует\\
 & другое (системная ошибка): выбор личного ключа завершился с ошибкой  \\
\hline
\end{tabular}

При разборе токена используется алгоритм $\texttt{bign-keytransport}^{-1}$
со стандартными параметрами, которые определяются неявно
по личному ключу. 

Команда может вызываться для приложения eSign в 
состояниях PS и AS:AT. В состоянии AS:AT команда 
может вызываться только авторизованным терминалом,
в сертификате которого задано право 
разбора токена ключа в терминальном режиме 
(см. \ref{DATA.Access}).

Команда требует предварительной аутентификации по 
протоколу BPACE c паролем PIN. 

\subsection{Инициализация протокола BAUTH}
\label{Oper.Descr.SetBAUTH}

Для инициализации протокола BAUTH используется
команда <MSE: Set AT> 
(аббревиатура от <<Manage Security Environment: Set 
Authentication Template>>), 
которая определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{22}$: управление средой безопасности\\ 
\hline
$\text{P1} \parallel\text{P2}$ & $\hex{C1A4}$: выбрать и 
инициализировать протокол BAUTH с взаимной 
аутентификацией\\ 
 & $\hex{81A4}$: выбрать и инициализировать протокол BAUTH с 
односторонней аутентификацией\\
\hline
CDF & Обязательный объект данных 
$\der(\hex{80}, X)$, где~$X$~--- 
закодированный объектный идентификатор (без поля тега и поля 
длины) протокола (см. приложение~\ref{ASN})\\
 & Обязательный объект данных $\der(\hex{85}, X)$, 
где~$X$ определяет хэш-значение запроса аутентификации (см.~\ref{FLOW}).\\
 & Обязательный объект данных~$X$, который является 
закодированным значением типа \verb|AuthAuxData| (см.~\ref{DATA.Optional}). 
Используется в команде <Verify> (см.~\ref{Oper.Descr.VerifyData}) 
для получения значений дополнительных атрибутов DocumentValidity, 
AgeVerification, RegionVerification. В~$X$ 
обязательно должны быть включены параметры атрибута DocumentValidity.\\
\hline \hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$ (успешное выполнение): протокол выбран и 
проинициализирован \\
 & $\hex{6A80}$ (некорректные данные в CDF): протокол не поддерживается или 
ошибка инициализации \\
 & $\hex{6A88}$ (ссылаемые данные не найдены): ключ недоступен \\
 & другое (системная ошибка): инициализация протокола завершилась с 
ошибкой\\
\hline
\end{tabular}

В случае если для команды <MSE: Set AT> в компоненте CDF необходимо 
передать несколько объектов данных, то они должны передаваться с помощью 
одной команды, т.е. использование цепочки команд <MSE: Set AT> не 
допускается. При этом порядок следования объектов данных в компоненте CDF 
не важен. 

Команда может вызываться на уровне мастер-файла в состоянии PS 
непосредственно после выполнения протокола BPACE (см. \ref{Oper.Descr.GABPACE}).

%\doubt{Для использования прикладной программы eID  должен инициализироваться
%протокол BAUTH с взаимной  аутентификацией.}

При успешном выполнении протокола BAUTH дата, которая передается в команде 
для проверки срока действия КТ, может использоваться для обновления даты, 
которая хранится на КТ (см.~\ref{OBJ.Date}). 


\subsection{Инициализация протокола BPACE}
\label{Oper.Descr.SetBPACE}

Для инициализации протокола BPACE используется команда
<MSE: Set AT> (аббревиатура от <<Manage Security Environment: Set 
Authentication Template>>), 
которая определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{22}$: управление средой безопасности\\ 
\hline
$\text{P1} \parallel\text{P2}$ & $\hex{C1A4}$: выбрать и 
инициализировать протокол BPACE\\ 
\hline
CDF & Обязательный объект данных 
$\der(\hex{80}, X)$, где~$X$~--- 
закодированный объектный идентификатор (без поля тега и поля 
длины) протокола (см. приложение~\ref{ASN})\\
& Обязательный объект данных $\der(\hex{83}, X)$, 
где $X$ определяет, какой пароль будет использоваться в протоколе: 
$\hex{02}$~--- CAN,  $\hex{03}$~--- PIN, 
$\hex{04}$~--- PUK\\
 & Необязательный объект данных~$X$, который является 
закодированным значением типа \verb|CertHAT| (см.~\ref{DATA.Access}). 
Используется для установки владельцем 
КТ ограничений на доступ к данным и сервисам определенной 
прикладной программы КТ.\\
 & Необязательный объект данных $\der(\hex{53}, N)$, 
где $N$ кодируется октетом и 
определяет количество последовательных подписей, 
которые могут быть выработаны в текущем сеансе 
без подтверждения владельца КТ.
При этом октеты $\hex{01}, \hex{02}, \ldots, \hex{FF}$
определяют для $X$ значения $1, 2, \ldots, 255$ соответственно, 
а октет $\hex{00}$ определяет, что может быть выработано 
неограниченное количество последовательных подписей. 
Может задаваться, если предполагается использование 
прикладной программы eSign.  
Если данный объект не задан, то прикладной программой eSign 
испольуется значение по умолчанию, равное 1. \\
\hline \hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$ (успешное выполнение): протокол выбран и 
проинициализирован \\
 & $\hex{6A80}$ (некорректные данные в CDF): протокол не поддерживается или 
ошибка инициализации \\
 & $\hex{6A88}$ (ссылаемые данные не найдены): пароль недоступен \\
 & $\hex{63CX}$ (предупреждение): пароль выбран, 
значение \texttt{X} содержит количество 
оставшихся попыток аутентификации, если оно не равно начальному 
(при $\texttt{X} = 1$ пароль приостановлен, а при $\texttt{X} = 0$~--- заблокирован)\\
 & другое (системная ошибка): инициализация протокола завершилась с 
ошибкой\\
\hline
\end{tabular}

В случае если для команды <MSE: Set AT> в компоненте CDF необходимо 
передать несколько объектов данных, то они должны передаваться с помощью 
одной команды, т.е. использование цепочки команд <MSE: Set AT> не 
допускается. При этом порядок следования объектов данных в компоненте CDF 
не важен. Например, для протокола BPACE, использующего PIN, компонент CDF, 
содержащий только обязательные объекты данных, может иметь вид: 
$\text{CDF} = 
\der(\hex{83}, \hex{03}) \parallel 
\der(\hex{80}, X)$, где~$X$~--- закодированный (без поля тега и 
поля длины) объектный идентификатор протокола BPACE (см. СТБ 34.101.66). 

%Для разблокировки или активации PIN (см.~\ref{OBJ.PIN})
%при инициализации BPACE в команде <MSE: Set AT> требуется использовать PUK 
%(см.~\ref{OBJ.PUK}).
%До выполнения протокола BPACE должна быть выбрана прикладная 
%программа КТ, пароль которой будет передаваться в команде <MSE: Set AT>. 
%Для этого должна быть вызвана команда <Select File> с нужным 
%идентификатором прикладной программы (AID, см. приложение~\ref{FILES}). 

Для возобновления PIN (см.~\ref{OBJ.PIN}) требуется 
использовать при инициализации BPACE пароль CAN. 
Тип пароля, который должен использоваться при 
инициализации BPACE для возможности выполнения различных 
операций, определяется в таблице~\ref{Table.Oper.List}.

При инициализации BPACE задаются разрешения 
владельца на доступ к сервисам и данным  
КТ, а также количество подписей, которые могут быть выработаны 
в текущем сеансе без подтверждения владельцем КТ пароля PIN.

Команда может вызываться в любом из состояний на уровне мастер-файла.

\subsection{Обновление данных}
\label{Oper.Descr.Update}

Для обновления данных элементарных файлов используется
команда <Update Binary>, 
которая определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\
\hline
\hline
INS & $\hex{D6}$: обновление бинарных данных\\
\hline
P1 & Старший байт смещения, с которого бдут перезаписываться данные 
(старший бит должен быть равен нулю) \\
\hline
P2 & Младший байт смещения, с которого будут перезаписываться данные \\
\hline
CDF & Записываемые данные \\
\hline \hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$ (успешное выполнение): данные перезаписаны успешно \\
 & $\hex{6982}$: команда не соответствует состоянию безопасности \\
 & $\hex{6985}$: файл не активирован \\
 & $\hex{6986}$: файл не найден \\
 & $\hex{6B00}$: некорректный параметр P1 или P2 \\
 & $\hex{6700}$: некорректное поле Lc\\
 & другое (системная ошибка): ошибка чтения \\
\hline
\end{tabular}

Размер данных, которые нужно записать, определяется компонентом Lс команды 
(см.~\cite{APDU}).

Команда может вызываться в состояниях PS, AS:AT 
для прикладной программы eSign и в состоянии 
AS:AT для прикладной программы eID.
В состоянии AS:AT команда может вызываться только 
авторизованным терминалом, в сертификате которого
задано право обновления соответствующего 
элементарного файла (см. \ref{DATA.Access}).

Для обновления элементарных файлов приложения eSign команда требует 
предварительной аутентификации по протоколу BPACE c 
паролем PIN.

Для обновления элементарных файлов приложения eID команда требует 
предварительной аутентификации по протоколу BPACE c 
паролем CAN или PIN.

Файл, в который записываются данные, должен быть предварительно
выбран (см. \ref{Oper.Descr.SelectEF}).
Для записи могут быть выбраны только те файлы, для которых 
нет ограничений по записи при текущем состоянии КТ (см.~\ref{DATA.Access}). 
При попытке записи в файлы, доступ к которым ограничен при текущем состоянии КТ, 
должен возвращаться статус $\text{SW1} \parallel\text{SW2} = \hex{6982}$. 


\subsection{Переключение между соединениями}
\label{Oper.Descr.SetCS}
Для переключения между защищенным соединением,
устанавливаемым между КТ и КП после выполнения 
протокола BPACE, и соединением, 
устанавливаемым между КТ и терминалом после выполнения 
протокола BAUTH, используется 
команда <MSE: Set CS> (аббревиатура от <<Manage Security Environment: Set 
Context switch>),
которая определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{22}$: управление средой безопасности\\ 
\hline
$\text{P1} \parallel\text{P2}$ & $\hex{01A4}$: 
переключиться между соединениями \\
\hline
CDF & 
$\der(\hex{E1}, \der(\hex{81}, X))$, 
где $X$ определяет идентификатор
соединения и принимает значение $\hex{00}$ для
переключения на защищенное соединение,
установленное между КТ и КП,
и значение $\hex{01}$ для переключения на защищенное
соединение, установленное между КТ и терминалом\\ 
\hline \hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$ (успешное выполнение): переключение 
между соединениями выполнено успешно \\
 & $\hex{6982}$ (не соответствует состоянию безопасности):
 запрашиваемое защищенное соединение не установлено  \\
 & $\hex{6A80}$ (некорректные данные в CDF): 
идентификатор контекста соединения задан неверно \\
 & другое (системная ошибка): переключение 
между контекстами не выполнено  \\
\hline
\end{tabular}

Команда может вызываться для приложений eID и eSign
в состоянии AS.

Команда требует предварительной аутентификации по протоколу BPACE
с паролем PIN или PUK.

Переключение между соединениями может понадобиться
при подтверждении (см. \ref{Oper.Descr.VerifyPIN}), 
изменении (см. \ref{Oper.Descr.ChangePIN})
или разблокировке (см. \ref{Oper.Descr.UnblockPIN}) PIN.

После успешного выполнения команды выделенный файл (см.~\ref{FILES}), 
соответствующий мастер-файлу, становится текущим.

\subsection{Подтверждение PIN}
\label{Oper.Descr.VerifyPIN}

Для подтверждения PIN используется команда
<Verify>, которая определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{20}$: проверить данные\\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{0003}$: 
проверка пароля PIN\\
\hline
CDF & пароль PIN в формате UTF8
\\
\hline \hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$ 
(успешное выполнение): аутентификация успешна\\
 & $\hex{63CX}$ (ошибка аутентификации): аутентификация неуспешна, 
значение \texttt{X} содержит количество оставшихся попыток аутентификации 
(при $\texttt{X} = 1$ пароль приостановлен, а при $\texttt{X} = 0$~--- 
заблокирован)\\ 
 & $\hex{6982}$ (не соответствует состоянию безопасности): команда не может 
быть выполнена для текущего состояния безопасности\\
% & \doubt{$\hex{6983}$ (аутентификация заблокирована): пароль заблокирован} \\
 & $\hex{6984}$ (необходимые данные не доступны): пароль деактивирован \\
% & \doubt{$\hex{6985}$ (не соответствует условиям использования): пароль приостановлен} \\
 & $\hex{6A88}$ (данные не найдены): заданный пароль не найден\\
\hline
\end{tabular}

Команда может вызываться для приложения eSign
в состояниях PS и AS:CP.

Команда требует предварительной аутентификации по 
протоколу BPACE с паролем PIN.

Успешное выполнение команды устанавливает 
статус подтверждения пароля PIN.
В свою очередь, неуспешное выполнение команды 
сбрасывает данный статус.

Команду может потребоваться вызвать после сброса статуса
подтверждения пароля PIN, который происходит 
после выработки определенного количества подписей (см.~\ref{Oper.Descr.Signature}),
генерации ключевой пары (см.~\ref{Oper.Descr.GenKeys}),
изменения пароля PIN (см.~\ref{Oper.Descr.ChangePIN}),
уничтожение личного ключа (см.~\ref{Oper.Descr.Terminate}).

\subsection{Получение значений дополнительных атрибутов}
\label{Oper.Descr.VerifyData}

Для получения значений дополнительных 
атрибутов DocumentValidity, AgeVerification, RegionVerification 
(см.~\ref{DATA.Optional}) 
используется команда  <Verify>, 
которая определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{20}$: проверить данные\\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{8000}$: 
получить значение дополнительного атрибута\\
\hline
CDF & Закодированный идентификатор дополнительного атрибута 
(см.~\ref{DATA.Optional}). 
Может принимать одно из значений 
\verb|id-DocumentValidity|, \verb|id-AgeVerification|, \verb|id-PlaceVerification| 
(см. приложение~\ref{ASN})\\
\hline \hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$ 
(успешное выполнение): проверка успешна\\
 & $\hex{6300}$: проверка неуспешна\\
 & $\hex{6A88}$: данные не найдены \\
 & $\hex{6982}$: команда не соответствует состоянию безопасности\\
 & другое (системная ошибка): ошибка при проверке данных\\
\hline
\end{tabular}

Команда может вызываться для приложения eID в состоянии AS:AT
авторизованным терминалом, в сертификате которого задано право
проверки соответствующего атрибута (см. \ref{DATA.Access}).  

Команда требует предварительной аутентификации по протоколу BPACE 
c паролем CAN или PIN.

Установка проверяемых командой данных производится 
при инициализации протокола BAUTH (см.~\ref{Oper.Descr.SetBAUTH}).  

Для команды должен использоваться $\text{CLA}=\hex{84}$ 
(прикладной класс для защищенного соединения без использования цепочки 
команд). 

\subsection{Проверка сертификата}
\label{Oper.Descr.VerifyCert}

Для проверки сертификата используется команда 
<PSO: Verify Certificate> (аббревиатура от <<Perform Security 
Operation: Verify Certificate>>).
Команда применяется для импорта и проверки 
сертификата при аутентификации терминала по протоколу BAUTH. 
Команда определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\ 
\hline
\hline
INS & $\hex{2A}$: управление средой безопасности \\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{00BE}$: проверить 
сертификат откыртого ключа \\ 
\hline
CDF & Закодированный стандартный сертификат (см.~\ref{CERTS.Std})\\
 & Закодированное значение компонента certificateBody, определяющего тело 
облегченного сертификата (см.~\ref{CERTS.Light})\\
 & Закодированное значение компонента signature, определяющего подпись 
облегченного сертификата (см.~\ref{CERTS.Light})\\
\hline \hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$ 
(успешное выполнение): сертификат успешно проверен и 
открытый ключ импортирован \\
 & другое (системная ошибка): открытый ключ не может быть импортирован\\
\hline
\end{tabular}

В компоненте CDF команды должен передаваться либо стандартный сертификат, 
либо тело и подпись облегченного сертификата. При последовательном вызове 
нескольких команд <PSO: Verify Certificate> в них должны использоваться 
сертификаты одного типа. 

Открытый ключ, используемый при проверке сертификата, извлекается из 
сертификата, который хранится на КТ или который был импортирован в КТ 
предшествующим успешным вызовом команды <PSO: Verify Certificate>.

% todo: пояснить процедуру проверки сертификата:
% - на КТ хранится сертификат/ОК доверенного УЦ; ОК помещается в буфер;
% - при проверке следующего сертификата из цепочки используется ОК из буфера,
% - при успехе проверки ОК из сертификата попадает в буфер, 
%   иначе буфер \doubt{очищается};
% - при последующей работе (выполнении шагов протокола BAUTH) используется 
%   ОК из буфера.

Команда может вызываться на уровне мастер-файла 
в состоянии PS непосредственно после 
инициализации протокола BAUTH (см. \ref{Oper.Descr.SetBAUTH}).

Команда требует предварительной аутентификации по протоколу BPACE 
c паролем CAN, PIN или PUK. Если аутентификация 
по протоколу BPACE выполнялась с паролем CAN,
то в сертификате терминала должно быть установлено 
право доступа по паролю CAN  (см. \ref{DATA.Access}).

\subsection{Проверка статуса подтверждения PIN}
\label{Oper.Descr.VerifyAuth}

Для проверки статуса подтверждения PIN
используется команда <Verify>, 
которая определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{20}$: проверить данные\\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{0003}$: проверить состояние аутентификации
для пароля PIN \\
\hline
CDF & --- \\
\hline \hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$ 
(успешное выполнение): КТ находится в состоянии аутентификации по паролю PIN\\
 & $\hex{6982}$ (не соответствует состоянию безопасности): 
%\doubt{
статус подтверждения пароля PIN не установлен
%} 
или команда не может быть выполнена для текущего состояния безопасности\\
 & другое (системная ошибка): состояние не может быть определено \\
\hline
\end{tabular}

Команда может вызываться для приложения eSign в состояниях PS и AS:AT.

Команда требует предварительной аутентификации по протоколу BPACE
c паролем PIN.

\subsection{Разблокировка PIN}
\label{Oper.Descr.UnblockPIN}

Для разблокировки PIN используется команда
<Reset Retry Counter>,
которая определяется следующим образом:
 
\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & 	Описание \\
\hline
\hline
INS & $\hex{2С}$: разблокировать PIN\\
\hline
P1 & $\hex{02}$: разблокировать PIN с его изменением\\
   & $\hex{03}$: разблокировать PIN без его изменения\\
\hline
P2 & $\hex{00}$: PIN выбран неявно\\
\hline
CDF & при $\text{P1} = \hex{02}$ содержит новое значение PIN в формате UTF8\\
 & при $\text{P1} = \hex{03}$ не задается \\
\hline \hline
RDF & 	 --- \\
\hline
$\text{SW1}\parallel\text{SW2}$ & $\hex{9000}$ (успешное выполнение): 
разблокировка PIN была выполнена успешно\\
 & $\hex{6982}$ (не соответствует состоянию безопасности): нет прав для 
выполнения операции\\
 & другое (системная ошибка): разблокировка PIN завершена неудачно\\
\hline
\end{tabular}


Команда может вызываться для приложения eSign в состояниях 
PS, AS:AT и для приложения eID в состоянии AS:AT. 
В состоянии AS:AT команда может вызываться 
только авторизованным терминалом,
в сертификате которого задано право 
управлять паролем PIN или право разблокировать пароль 
PIN (см. \ref{DATA.Access}).

Команда требует предварительной аутентификации по 
протоколу BPACE c паролем PUK. 

\subsection{Разбор токена ключа}
\label{Oper.Descr.Decipher}

Для разбора токена ключа используется 
команда <PSO: Decipher> (аббр. от 
<<Perform Security Operation: Decipher>>), 
которая определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\ 
\hline
\hline
INS & $\hex{2A}$: управление средой безопасности \\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{8086}$: расшифровать
данные \\ 
\hline
CDF & токен ключа, длина которого не
меньше 96 октетов и не больше 112 октетов\\
\hline \hline
RDF &  расшифрованный ключ \\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$ 
(успешное выполнение): подпись успешно выработана \\
 & $\hex{6982}$ (не соответствует состоянию безопасности): ТИ не 
авторизован для выработки подписи\\
 & $\hex{6984}$ (необходимые данные не доступны): ключ уже существует\\
 & $\hex{6A80}$ (некорректные данные): некорректная длина токена или 
нарушена его целостность\\
 & другое (системная ошибка): токен не может быть разобран\\
\hline
\end{tabular}

В компоненте CDF команды должен передаваться токен ключа, 
сформированный с нулевым заголовком ключа. 
Параметры алгоритма разбора токена определяются неявно
по ключу, выбираемому при инициализации алгоритма
разбора токена. 

Команда может вызываться для приложения eSign в состояниях 
PS и AS:AT непосредственно после инициализации алгоритма 
разбора токена (см.~\ref{Oper.Descr.SetCT}).

%Порядок, в котором должна вызываться команда, 
%определяется в~\ref{Oper.Seq.Decipher}.

\subsection{Сброс статуса подтверждения PIN}
\label{Oper.Descr.VerifyDeauth}

Для сброса статуса подтверждения пароля PIN
используется команда <Verify>,
которая определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{20}$: проверить данные\\
\hline
$\text{P1} \parallel \text{P2}$ & $\hex{FF03}$: сбросить статуса подтверждения
пароля PIN  \\
\hline
CDF & ---
\\
\hline \hline
RDF &  --- \\
\hline
$\text{SW1} \parallel \text{SW2}$ & $\hex{9000}$ 
(успешное выполнение): статус подтверждения пароля PIN сброшен успешно\\
 & $\hex{6982}$ (не соответствует состоянию безопасности): 
%\doubt{
статус подтверждения пароля PIN не установлен
%} 
или команда не может быть выполнена для текущего состояния КТ\\
 & другое (системная ошибка): состояние подтверждения 
пароля PIN не может быть сброшено\\
\hline
\end{tabular}

Команда может вызываться для приложения eSign  
в состояниях PS и AS:AT.

Команда требует предварительной аутентификации 
по протоколу BPACE c паролем PIN.

Успешное выполнение команды сбрасывает статус подтверждения пароля PIN,
а неуспешное~--- не изменяет его статус.

\subsection{Чтение данных}
\label{Oper.Descr.Read}

Для чтения данных из элементарных файлов 
используется команда <Read Binary>, 
которая определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание \\
\hline
\hline
INS & $\hex{B0}$: чтение бинарных данных \\
\hline
P1 & Старший байт смещения, с которого будут читаться данные (старший бит 
должен быть равен нулю) \\
\hline
P2 & Младший байт смещения, с которого будут читаться данные\\
\hline
CDF &  --- \\
\hline \hline
RDF & 	Прочитанные данные \\
\hline
$\text{SW1} \parallel\text{SW2}$ & 
$\hex{9000}$ (успешное выполнение): данные прочитаны успешно \\
 & $\hex{6982}$: команда не соответствует состоянию безопасности \\
 & $\hex{6985}$: файл не активирован \\
 & $\hex{6986}$: файл не найден \\
 & $\hex{6B00}$: некорректные параметры $\text{P1} \parallel\text{P2}$ \\
 & $\hex{6C00}$: некорректное поле Le \\
 & другое ( системная ошибка ): ошибка чтения \\
\hline
\end{tabular}

Размер данных, которые нужно прочитать, определяется компонентом 
Le (см.~\cite{APDU}).

Команда может вызываться в состояниях PS, AS:AT 
для прикладной программы eSign и в состоянии 
AS:AT для прикладной программы eID.
В состоянии AS:AT команда может вызываться только 
авторизованным терминалом, в сертификате которого
задано право чтения соответствующего 
элементарного файла (см. \ref{DATA.Access}).

Для чтения элементарных файлов приложения eSign команда требует 
предварительной аутентификации по протоколу BPACE c 
паролем PIN.

Для чтения элементарных файлов приложения eID команда требует 
предварительной аутентификации по протоколу BPACE c 
паролем CAN или PIN.

Элементарный файл, из которого читаются данные, должен быть предварительно 
выбран (см. \ref{Oper.Descr.SelectEF}). Прочитаны могут быть только те данные, 
для которых нет ограничений по чтению при текущем состоянии КТ (см.~\ref{DATA.Access}). 
При попытке чтения данных, доступ к которым ограничен, должен возвращаться 
статус $\text{SW1} \parallel \text{SW2} = \hex{6982}$.



\subsection{Уничтожение личного ключа}
\label{Oper.Descr.Terminate}

Для уничтожения личного ключа используется команда <Terminate>,
которая определяется следующим образом:

\noindent
\begin{tabular}{|c|p{14cm}|}
\hline
Компонент & Описание\\
\hline
\hline
INS & $\hex{E6}$: уничтожить личный ключ \\
\hline
$\text{P1} \parallel\text{P2}$ & $\hex{2100}$:
ссылка на личный ключ задается в поле данных\\
\hline
CDF &  $\der(\hex{B6},\der(\hex{84}, X))$,
%$\der(\hex{84}, X)$,  
где $X$ определяет ссылку на личный ключ
(см. табл. \ref{Table.Oper.KeyRef})\\ 
%В состоянии PS может принимать 
%значение 1 для ключа уровня стойкости $l=128$, 
%значение 2 для ключа уровня стойкости $l=192$, 
%значение 3 для ключа уровня стойкости $l=256$.
%В состоянии AS может принимать 
%значение 4 для ключа уровня стойкости $l=128$, 
%значение 5 для ключа уровня стойкости $l=192$, 
%значение 6 для ключа уровня стойкости $l=256$. \\
\hline \hline
RDF & ---  \\
\hline
$\text{SW1} \parallel \text{SW2}$ & 
$\hex{9000}$ (успешное выполнение): ключ уничтожен\\
 & $\hex{6982}$ (не соответствует состоянию безопасности): терминал не 
авторизован для уничтожения ключа\\
 & $\hex{6A88}$ (необходимые данные не найдены): неверная ссылка на ключ\\
 & другое (системная ошибка): генерация ключевой пары выполнена
неудачно\\
\hline
\end{tabular}

Команда может вызываться для приложения eSign в состояниях PS и AS:AT.
В состоянии AS:AT команда может вызываться только
авторизованным терминалом, в сертификате которого задано право
управлять ключами (см. \ref{DATA.Access}).
В каждом из состояний могут быть уничтожены только те ключи, которые
были сгенерированы в данном состоянии (см. \ref{Oper.Descr.GenKeys}).

Команда требует предварительной аутентификации по протоколу BPACE
c паролем PIN. При вызове команды статус подтверждения пароля PIN 
должен быть установлен.

Выполнение команды приводит к сбрасыванию статуса подтверждения пароля PIN.
Для установки статуса подтверждения пароля PIN 
необходимо либо подтвердить пароль PIN (см.~\ref{Oper.Descr.VerifyPIN}), 
либо повторно выполнить аутентификацию по паролю PIN (см.~\ref{Oper.Seq.BPACE}).

При попытке уничтожить ключ, который не был сгенерирован
или который был уничтожен ранее, должен возвращаться 
статус $\text{SW1} \parallel \text{SW2} = \hex{9000}$.