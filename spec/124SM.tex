\section{Формат сообщений защищенного соединения}
\label{CMDS.SM}

Команда и ответ на команду передаются в виде сообщений 
$\text{cmd} = \text{CLA} \parallel \text{INS} \parallel \text{P1} \parallel 
\text{P2} \parallel \text{Lc} \parallel \text{CDF} \parallel \text{Le}$ и 
$\text{res} = \text{RDF} \parallel \text{SW1} \parallel \text{SW2}$ 
соответственно, где 
Lc, CDF, Le и RDF в зависимости от инструкции и параметров команды могут 
быть пустыми словами, т.е. отсутствовать (см.~\ref{CMDS.Intro}). 

При передаче по защищенному соединению команда cmd и ответ res 
преобразуются в защищенную команду 
$\text{cmd*} = \text{CLA*} \parallel \text{INS} \parallel \text{P1} 
\parallel \text{P2} \parallel \text{Lс*} \parallel \text{CDF*} 
\parallel \text{Le*}$ и защищенный ответ 
$\text{res*} = \text{RDF*} \parallel \text{SW1} \parallel \text{SW2}$ 
соответственно. Для защищенных команд и ответов все компоненты имеют 
ненулевую длину. 

Для защищенной команды в CLA* устанавливается один из битов, который 
является признаком защиты, Lc* кодирует длину компонента CDF* 
(см.~\ref{CMDS.Intro}), а Le* всегда устанавливается в $\hex{00}$.  

В CDF* могут включаться зашифрованный компонент CDF (совместно с 
индикатором, который является признаком наличия зашифрованных данных) и 
компонент Le, а также обязательно включается имитовставка, используемая 
для контроля целостности и подлинности команды.  Аналогично защищенной 
команде для защищенного ответа в RDF* может включаться зашифрованный 
компонент RDF (совместно с индикатором наличия зашифрованных данных) и 
обязательно включается имитовставка, используемая для контроля 
целостности и подлинности ответа. 

При формировании компонент CDF* и RDF*, включаемые в них объекты данных, 
кодируются с использованием отличительных правил (см.~\ref{CMDS.Intro}). 
В таблице~\ref{Table.CMDS.CDFRDF} 
приводятся объекты данных, которые могут включаться в CDF* и RDF*, и 
указываются их допустимые длины и теги, используемые при кодировании 
(некоторые из объектов данных могут включаться только в CDF* или RDF*). 

\begin{table}[h]
\caption{Объекты данных компонент CDF* и RDF*}
\label{Table.CMDS.CDFRDF}
\begin{tabular}{|c|c|c|}
\hline
Описание объекта данных & Длина & Тег \\
\hline
\hline
Индикатор совместно с зашифрованными данными & не менее 2 & $\hex{87}$ \\
\hline
Защищенное значение Le & 2 или 3 & $\hex{97}$\\
\hline
Защищенные статусы SW1 и SW2 & 2 & $\hex{99}$ \\
\hline      
Имитовставка & 8 & $\hex{8E}$ \\
\hline
\end{tabular}
\end{table}

Ниже описываются правила кодирования, которые используются при защите 
команд и ответов. При описании данных правил через~$\len(X)$ обозначается 
длина непустого слова~$X$, закодированная минимально возможным количеством 
октетов согласно~\ref{CMDS.Intro} для случая кодирования компонента Lc. 

{\bf Защита команд}. 
Команда защищается с помощью алгоритма~\ref{CRYPTO.SM.Algs.Encr}. 
При этом в 
качестве заголовка $I$ выступает слово 
$\text{CLA} \parallel \text{INS} \parallel \text{P1} \parallel \text{P2}$ 
(4 октета), а 
в качестве критического сообщения $X$ --- слово CDF (кодовое представление 
длины $X$ задается в компоненте Lc). 

На шаге 2 алгоритма установки защиты заголовок $I$ и зашифрованное сообщение 
$Y$ кодируются с помощью следующего алгоритма: 

\begin{enumerate}
\item
Установить $Z \gets I \in \hex{04000000}$.

\item
Если $|Y| > 0$, то $Z \gets Z \parallel \der(\hex{87}, \hex{02}\parallel Y)$.
\item
Если $\text{Le} > 0$, то $Z\gets Z \parallel \der(\hex{97}, \text{Le})$.

\item
Возвратить $Z$ в качестве $\langle\langle I, Y \rangle\rangle$.
\end{enumerate}

На шаге 3 алгоритма установки защиты заголовок $I$, защищенное сообщение $Y$ и 
имитовставка $T$ кодируются с помощью следующего алгоритма: 

\begin{enumerate}
\item
Установить $Z\gets I \in \hex{04000000}$.
\item
Положить переменную W равной пустому слову.
\item
Если $|Y| > 0$, то $W\gets \der(\hex{87}, \hex{02} \parallel Y)$.
\item
Если $Le > 0$, то $W\gets W \parallel \der(\hex{97}, \text{Le})$.
\item
Установить $W\gets W \parallel \der(\hex{8E}, T)$.
\item
Установить $Z\gets Z \parallel \len(W) \parallel W \parallel \hex{00}$.
\item
Возвратить $Z$ в качестве $\langle\langle I, Y, T \rangle\rangle$.
\end{enumerate}

Кодовое представление $\langle\langle I, Y, T \rangle\rangle$, полученное 
в результате работы алгоритма, представляет собой защищенную команду cmd*. 

{\bf Защита ответов}. 
Ответ защищается с помощью алгоритма~\ref{CRYPTO.SM.Algs.Encr}. При этом в 
качестве заголовка~$I$ выступает слово $\text{SW1} \parallel\text{SW2}$ 
(2 октета), а в качестве критического сообщения $X$~--- слово RDF. 
На шаге 2 алгоритма установки защиты заголовок $I$ и защищенное сообщение $Y$ 
кодируются с помощью следующего алгоритма: 

\begin{enumerate}
\item
$Z\gets \der(\hex{99}, I)$.
\item
Если $|Y| > 0$,  то $Z\gets \der(\hex{87}, \hex{02} \parallel Y) \parallel Z$. 
\item
Возвратить $Z$ в качестве $\langle\langle I, Y \rangle\rangle$.
\end{enumerate}

На шаге 3 алгоритма установки защиты заголовок $I$, защищенное сообщение $Y$ и 
имитовставка $T$ кодируются с помощью следующего алгоритма: 

\begin{enumerate}
\item 
Установить $W\gets\der(\hex{8E}, T)$.
\item 
Если $|Y| > 0$, 
то $W \gets \der(\hex{87}, \hex{02}\parallel Y) \parallel W$.
\item
Установить $Z \gets W \parallel \der(\hex{99}, I)$.
\item
Возвратить $Z$ в качестве $\langle \langle I, Y, T\rangle\rangle$.
\end{enumerate}

Кодовое представление  $\langle\langle I, Y, T \rangle\rangle$, 
полученное в результате работы алгоритма, 
представляет собой защищенный ответ res*. 
В защищенном ответе в поле RDF* передается слово $W$, 
которое является кодовым представлением $Y$ и $T$. 

{\bf Снятие защиты с команд и ответов}. 
%
Снятие защиты с команды и ответа производится с помощью 
алгоритма~\ref{CRYPTO.SM.Algs.Decr}.  
При снятии защиты выполняются обратные к установке защиты действия: 
защищенные команда cmd* и ответ res* преобразуются в исходные команду cmd  
и ответ res.  

{\bf Принудительное закрытие защищенного соединения.}
%
КТ должен принудительно закрыть текущее защищенное соединение только в том случае, 
когда при снятии защиты с команды обнаружено, что: 
\begin{enumerate}
\item[1)] команда представлена в незащищенном виде;
\item[2)] отсутствует необходимый объект данных;
\item[3)] объект данных является некорректным.
\end{enumerate}

В первом и втором случаях КТ должен вернуть 
статус~$\text{SW1} \parallel \text{SW2} = \hex{6987}$, 
а в третьем случае~--- статус~$\text{SW1} \parallel \text{SW2} = 
\hex{6988}$.  

При принудительном закрытии защищенного соединения КТ должен уничтожить 
ключи, используемые для защиты, \doubt{и сбросить права доступа в первоначальные}. 
